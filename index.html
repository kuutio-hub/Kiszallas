
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kisz√°ll√°s</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpolygon points='50 5, 95 27.5, 95 72.5, 50 95, 5 72.5, 5 27.5' fill='%23002244' stroke='%2369BE28' stroke-width='8'/%3E%3Ctext x='50' y='75' font-family='sans-serif' font-size='60' font-weight='bold' fill='%2369BE28' text-anchor='middle'%3EK%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        @font-face {
            font-family: 'DejaVuSans';
            src: url('https://cdn.jsdelivr.net/gh/dejavu-fonts/dejavu-fonts-ttf/ttf/DejaVuSans.ttf') format('truetype');
        }
        :root {
            --seahawks-navy: #002244; --seahawks-green: #69BE28; --seahawks-gray: #A5ACAF;
            --bg-primary: #1a202c; --bg-secondary: #2d3748; --bg-tertiary: #4a5568;
            --text-primary: #edf2f7; --text-secondary: #a0aec0; --text-on-accent: #000000;
            --border-color: #4a5568;
            --accent-primary: var(--seahawks-green);
            --accent-secondary: color-mix(in srgb, var(--seahawks-green) 85%, black);
            --danger-primary: #9B2C2C;
            --warning-text: #fca5a5;
            --success-primary: var(--seahawks-green);
            --font-family: 'Segoe UI', system-ui, sans-serif;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --border-radius: 0.5rem;
            --glow-color: color-mix(in srgb, var(--seahawks-green) 80%, transparent);
            --glow-color-darker: color-mix(in srgb, var(--seahawks-green) 70%, black 40%);
        }

        .light-mode {
            --bg-primary: #f8f9fa; --bg-secondary: #ffffff; --bg-tertiary: #e9ecef;
            --text-primary: #212529; --text-secondary: #6c757d; --text-on-accent: #ffffff;
            --border-color: #dee2e6; --accent-primary: #0d6efd; --accent-secondary: #0b5ed7;
            --danger-primary: #dc3545; --warning-text: #dc3545; --success-primary: #198754;
            --glow-color: color-mix(in srgb, var(--accent-primary) 50%, transparent);
            --glow-color-darker: color-mix(in srgb, var(--accent-primary) 60%, black 20%);
        }

        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; text-align: right; }
        input.formatted-input { text-align: right; }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); font-size: 14px; transition: background-color 0.3s, color 0.3s; overflow-x: hidden; }
        
        #landing-page { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; text-align: center; padding: 1rem; }
        #landing-content { background-color: var(--bg-secondary); padding: 2.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); width: 100%; max-width: 400px; border: 1px solid var(--border-color); }
        #landing-content h1 { margin-bottom: 2rem; color: var(--accent-primary); font-size: 1.8rem; }
        #password-input { width: 100%; padding: 0.8rem; margin-bottom: 1.5rem; border-radius: 0.3rem; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); text-align: center; font-size: 1rem; }
        
        #app-container { display: none; }
        .container { max-width: 1800px; margin: 1rem auto; padding: 1rem; width: 100%; }

        .header { display: flex; flex-wrap: wrap; gap: 0.8rem; align-items: stretch; margin-bottom: 1.5rem; }
        .header-item { display: flex; align-items: center; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow); flex-grow: 1; min-width: 180px; }
        .header-item-title { padding: 0.5rem 0.8rem; font-weight: bold; color: var(--text-primary); background-color: var(--bg-tertiary); white-space: nowrap; font-size: 0.85rem; }
        .header input, .header select { padding: 0.5rem; border: none; background-color: transparent; color: var(--text-primary); font-size: 0.9rem; width: 100%; }
        .header input:focus, .header select:focus { outline: none; box-shadow: 0 0 0 3px var(--glow-color); }
        
        .input-with-button { display: flex; align-items: center; flex-grow: 1; }
        .input-with-button input { padding-right: 2.5rem !important; }
        .input-with-button button { padding: 0 0.6rem; border: none; background-color: var(--bg-tertiary); color: var(--text-primary); cursor: pointer; transition: background-color 0.2s; height: 100%; position: absolute; right: 0; top: 0; border-top-right-radius: var(--border-radius); border-bottom-right-radius: var(--border-radius); }
        .header-item .input-with-button { position: relative; }
        .input-with-button button:hover { background-color: var(--accent-primary); color: var(--text-on-accent); }
        
        .seahawks-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding-right: 2rem !important; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2369BE28'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; }
        .header-action-btn { cursor: pointer; background: var(--bg-secondary); border-left: 1px solid var(--border-color); padding: 0.5rem; display: flex; align-items: center; justify-content: center; }
        
        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: var(--border-radius); font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out; box-shadow: var(--shadow); background-color: var(--bg-tertiary); color: var(--text-primary); display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 0 0 3px var(--glow-color-darker); }
        .btn-danger { background-color: var(--danger-primary); color: #ffffff; }
        .btn-success { background-color: var(--success-primary); color: var(--text-on-accent); }
        .btn-icon { font-size: 1.2em; }
        
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        
        .card { background-color: var(--bg-secondary); border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        details.card { padding: 0; overflow: hidden; margin-bottom: 1rem; }
        details.card summary { padding: 1rem; cursor: pointer; font-size: 1.05rem; font-weight: 600; position: relative; display: flex; justify-content: space-between; align-items: center; list-style: none; }
        details.card summary::-webkit-details-marker { display: none; }
        details.card summary::after { content: ''; display: inline-block; width: 20px; height: 20px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23a0aec0'%3E%3Cpath d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z'/%3E%3C/svg%3E"); transition: transform 0.2s; }
        details[open].card > summary::after { transform: rotate(180deg); }
        details.card .card-content { padding: 1rem; }
        
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--border-color); text-align: left; }
        thead { background-color: var(--seahawks-navy); color: var(--text-primary); }
        .discount-row td { color: var(--warning-text); }
        .success-row td { color: var(--success-primary); font-weight: bold; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .form-group label { margin-bottom: 0.4rem; font-size: 0.8rem; color: var(--text-secondary); display: block; }
        .form-group input, .form-group select { width: 100%; padding: 0.5rem; border-radius: 0.3rem; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); }
        .travel-unit-toggle { cursor: pointer; text-decoration: underline; color: var(--accent-primary); }
        
        .card-controls { display: flex; justify-content: flex-end; align-items: center; gap: 1rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        
        .action-bar { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; margin-top: 1.5rem; padding: 1rem; background-color: var(--bg-secondary); border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .print-controls-group { display: flex; flex-direction: column; gap: 0.8rem; border: 1px solid var(--border-color); padding: 0.8rem; border-radius: var(--border-radius); }
        .print-controls-group #print-btn { width: 100%; }
        .print-group { display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .radio-pill { cursor: pointer; }
        .radio-pill input { display: none; }
        .radio-pill span { padding: 0.35rem 0.7rem; border-radius: 0.3rem; font-size: 0.75rem; display: inline-block; color: var(--text-secondary); transition: 0.2s; }
        .radio-pill input:checked + span { background-color: var(--accent-primary); color: var(--text-on-accent); font-weight: bold; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        #print-preview-modal, #wiki-modal { z-index: 2001; }
        .modal-content { background-color: var(--bg-secondary); margin: 5vh auto; padding: 1.5rem; width: 90%; max-width: 900px; border-radius: var(--border-radius); border: 1px solid var(--border-color); display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-body { overflow-y: auto; flex-grow: 1; }
        .modal-body h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--accent-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        .modal-body p, .modal-body li { line-height: 1.6; color: var(--text-primary); }
        .modal-body ul { padding-left: 20px; margin-bottom: 1rem;}
        .modal-footer { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .modal-close-btn { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; }
        
        #print-preview-iframe { width: 100%; height: 60vh; border: 1px solid var(--border-color); background-color: #fff; }

        .mobile-results-btn { display: none; }
        .close-mobile-results { display: none; }

        #rate-editor-fields {
            display: grid;
            grid-template-columns: auto 1fr 30px;
            gap: 0.8rem 1.2rem;
            align-items: center;
        }
        #rate-editor-fields .rate-group-title, 
        #rate-editor-fields .rate-item-separator,
        #rate-editor-fields .rate-item-vertical-spacer {
            grid-column: 1 / -1;
        }
        #rate-editor-fields .rate-group-title {
            margin-top: 1.5rem; margin-bottom: 0.5rem; font-size: 1rem;
            color: var(--accent-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;
        }
        #rate-editor-fields .rate-group-title:first-of-type { margin-top: 0; }
        #rate-editor-fields .rate-item-separator {
            border: 0;
            border-top: 1px dashed var(--border-color);
            margin: 1rem 0 0.2rem 0;
            padding: 0;
            height: 0;
        }
         #rate-editor-fields .rate-item-vertical-spacer { height: 0.5rem; }
        #rate-editor-fields label {
            text-align: left;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        #rate-editor-fields input.formatted-input {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .other-cost-item {
            display: flex; flex-direction: column; gap: 0.8rem; border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem; margin-bottom: 1rem; position: relative;
            padding-left: 0.5rem; border-left: 3px solid transparent; transition: border-color 0.3s;
        }
        .other-cost-item.unsaved { border-left-color: var(--accent-primary); }
        .other-cost-row-1, .other-cost-row-2 { display: flex; flex-wrap: wrap; gap: 0.8rem; align-items: flex-end; }
        .other-cost-row-1 .description { flex: 1 1 auto; }
        .other-cost-row-2 .quantity { flex: 0 1 70px; }
        .other-cost-row-2 .unit { flex: 0 1 80px; }
        .other-cost-row-2 .amount { flex: 0 1 120px; }
        .other-cost-row-2 .cost-toggle-container { flex: 1 1 150px; display: flex; gap: 0.8rem; align-items: flex-end; }
        .other-cost-row-2 .is-cost-item-group { padding-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; }
        .other-cost-actions { display: flex; gap: 0.5rem; }
        .other-cost-action-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .other-cost-action-btn svg { width: 20px; height: 20px; }
        .other-cost-action-btn.save:hover { background-color: var(--success-primary); }
        .other-cost-action-btn.delete:hover { background-color: var(--danger-primary); }


        #calculation-summary-header-content { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; padding: 1rem; }
        #calculation-summary-header-content .summary-title { flex-basis: 100%; text-align: center; font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: var(--accent-primary); }
        #calculation-summary-header-content .summary-col { flex: 1; min-width: 200px; padding: 0 1rem; }
        #calculation-summary-header-content .summary-col p { margin-bottom: 0.3rem; }
        #calculation-summary-header-content .summary-col strong { color: var(--text-secondary); margin-right: 0.5em; }
        
        @media (min-width: 1024px) {
            .main-grid { grid-template-columns: 1fr 1.5fr; }
        }

        @media (max-width: 1023px) {
            .container { padding: 0.5rem; }
            .header-item { min-width: calc(50% - 0.4rem); }
            .action-bar { flex-direction: column; align-items: stretch; }
            .action-bar .btn { flex-grow: 1; width: auto; }
            .action-bar .print-controls-group { width: 100%; }
            .calculation-table { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 3000; background: var(--bg-primary); overflow-y: auto; padding: 1rem; flex-direction: column; }
            .calculation-table.mobile-visible { display: flex; }
            .calculation-table .table-wrapper { flex-grow: 1; }
            .close-mobile-results { display: block; margin-top: 1rem; }
            .mobile-results-btn { display: flex; position: fixed; bottom: 1rem; right: 1rem; z-index: 2500; width: 56px; height: 56px; border-radius: 50%; align-items: center; justify-content: center; font-size: 1.5rem; background-color: var(--accent-primary); color: var(--text-on-accent); box-shadow: 0 4px 12px rgba(0,0,0,0.3); border: none; cursor: pointer; }
            .copyright-version::before { content: '\\A'; white-space: pre; }
        }
        
        footer { text-align: center; padding: 2rem 1rem; color: var(--text-secondary); font-size: 0.8rem; margin-top: 2rem; border-top: 1px solid var(--border-color); }
    </style>
</head>
<body>

    <div id="landing-page">
        <div id="landing-content">
            <h1>K√∂lts√©gkalkul√°tor</h1>
            <form id="password-form">
                <input type="password" id="password-input" placeholder="Jelsz√≥" required autocomplete="current-password">
                <button type="submit" class="btn btn-success" style="width: 100%;">Bel√©p√©s</button>
            </form>
        </div>
        <footer id="landing-footer" style="border:none; padding-top: 2rem;"></footer>
    </div>

    <div id="app-container">
        <div class="container">
            <header class="header">
                 <div class="header-item">
                    <span class="header-item-title">√Årlista</span>
                    <select id="rate-package-select" class="seahawks-select"></select>
                </div>
                <div class="header-item">
                    <span class="header-item-title">P√©nznem</span>
                    <select id="currency-select" class="seahawks-select">
                        <option value="HUF">HUF</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
                <div class="header-item">
                    <span class="header-item-title" id="exchange-rate-title">√Årfolyam</span>
                    <div class="input-with-button">
                        <input type="text" id="exchange-rate-manual" step="0.01" class="formatted-input">
                        <button id="exchange-rate-apply-btn" title="Alkalmaz">‚úì</button>
                    </div>
                </div>
                <div class="header-item">
                    <span class="header-item-title">Kedvezm√©ny (%)</span>
                    <div class="input-with-button">
                        <input type="text" id="discount-input" placeholder="0" min="0" max="100" class="formatted-input">
                        <button id="discount-apply-btn" title="Alkalmaz">‚úì</button>
                    </div>
                </div>
                <div class="header-item" style="border:none; box-shadow:none; background:transparent; flex-grow:0; display:flex; gap: 0.5rem; min-width: auto;">
                    <button id="reset-btn" class="btn" title="Mindent t√∂r√∂l">Vissza√°ll√≠t√°s</button>
                    <div id="theme-switcher" class="header-action-btn" title="T√©ma v√°lt√°s" style="border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 0.5rem;">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px;"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06z"/></svg>
                    </div>
                    <button id="wiki-btn" class="header-action-btn" title="S√∫g√≥" style="border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 0.5rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.89 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                    </button>
                </div>
            </header>

            <main class="main-grid">
                <div class="inputs-container">
                     <details class="card" open>
                        <summary>Alapadatok</summary>
                        <div class="card-content">
                            <div class="form-grid">
                                <div class="form-group"><label for="offer_number">Aj√°nlatsz√°m</label><input type="text" id="offer_number"></div>
                                <div class="form-group"><label for="project_number">Projektsz√°m</label><input type="text" id="project_number" placeholder="Opcion√°lis"></div>
                                <div class="form-group"><label for="project_name">Projekt neve</label><input type="text" id="project_name" placeholder="Opcion√°lis"></div>
                                <div class="form-group"><label for="customer">Megrendel≈ë</label><input type="text" id="customer"></div>
                                <div class="form-group"><label for="calculation_date">Kalkul√°ci√≥ d√°tuma</label><input type="date" id="calculation_date"></div>
                                <div class="form-group"><label for="creator_name">K√©sz√≠t≈ë</label><input type="text" id="creator_name" placeholder="Opcion√°lis"></div>
                                <div class="form-group" style="grid-column: 1 / -1;"><label for="feladat">Feladat le√≠r√°sa</label><input type="text" id="feladat" style="max-width: none;"></div>
                            </div>
                            <div class="card-controls"><button class="btn card-save-btn btn-success">Ment√©s √©s bez√°r√°s</button></div>
                        </div>
                    </details>
                    
                    <details class="card"><summary>Utaz√°s</summary><div class="card-content"><div class="form-grid" id="utazas-inputs"></div><div class="card-controls"><button class="btn card-save-btn btn-success">Ment√©s √©s bez√°r√°s</button></div></div></details>
                    <details class="card"><summary>Szerel≈ëk</summary><div class="card-content"><div class="form-grid" id="szerelo-inputs"></div><div class="card-controls"><button class="btn card-save-btn btn-success">Ment√©s √©s bez√°r√°s</button></div></div></details>
                    <details class="card"><summary>M√©rn√∂k√∂k</summary><div class="card-content"><div class="form-grid" id="mernok-inputs"></div><div class="card-controls"><button class="btn card-save-btn btn-success">Ment√©s √©s bez√°r√°s</button></div></div></details>
                    <details class="card"><summary>Eszk√∂z√∂k</summary><div class="card-content"><div class="form-grid" id="emelogep-inputs"></div><div class="card-controls"><button class="btn card-save-btn btn-success">Ment√©s √©s bez√°r√°s</button></div></div></details>

                    <details class="card">
                        <summary>Egy√©b k√∂lts√©gek</summary>
                        <div class="card-content">
                            <div id="other-costs-list"></div>
                            <div class="item-list-controls" style="margin-top: 1rem; padding-bottom: 1rem;">
                                <button id="add-other-cost-btn" class="btn">+ √öj t√©tel</button>
                            </div>
                            <div class="card-controls"><button class="btn card-save-btn btn-success">Ment√©s √©s bez√°r√°s</button></div>
                        </div>
                    </details>
                     
                     <div class="action-bar">
                        <button id="manage-rates-btn" class="btn">
                            <span role="img" aria-hidden="true" class="btn-icon">‚öôÔ∏è</span><span class="btn-text">√Årlist√°k</span>
                        </button>
                        <button id="export-xls-btn" class="btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                            <span class="btn-text">Export XLS</span>
                        </button>
                        <div class="print-controls-group">
                            <div class="print-group">
                                <label class="radio-pill"><input type="radio" name="print-detail" value="simple" checked><span>Egyszer≈±</span></label>
                                <label class="radio-pill"><input type="radio" name="print-detail" value="detailed"><span>R√©szletes</span></label>
                                <label class="radio-pill"><input type="radio" name="print-detail" value="internal"><span>Teljes</span></label>
                            </div>
                            <button id="print-btn" class="btn btn-success">
                                <span role="img" aria-hidden="true" class="btn-icon">üñ®Ô∏è</span><span class="btn-text">Nyomtat√°s</span>
                            </button>
                        </div>
                     </div>
                </div>
                
                <div class="card calculation-table" id="results-panel">
                    <button class="btn close-mobile-results btn-danger">Bez√°r√°s</button>
                    <details class="card" id="calculation-summary-header">
                        <summary>Projekt Adatok</summary>
                        <div id="calculation-summary-header-content"></div>
                    </details>
                    <div class="table-wrapper">
                        <table>
                            <thead id="breakdown-head"></thead>
                            <tbody id="breakdown-body"></tbody>
                            <tfoot id="breakdown-foot"></tfoot>
                        </table>
                    </div>
                </div>
            </main>
            <button class="mobile-results-btn" id="mobile-results-btn" title="Eredm√©nyek">üìä</button>
            <footer id="copyright-footer"></footer>
        </div>
    </div>
    
    <div id="print-preview-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nyomtat√°si el≈ën√©zet</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <iframe id="print-preview-iframe"></iframe>
            </div>
            <div class="modal-footer" style="justify-content: flex-end;">
                <button id="execute-print-btn" class="btn btn-success">Nyomtat√°s ind√≠t√°sa</button>
            </div>
        </div>
    </div>

    <div id="rate-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>D√≠jt√©telek M√≥dos√≠t√°sa</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid" style="grid-template-columns: 1fr; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label for="rate-package-selector-modal">V√°lasszon √°rlist√°t</label>
                        <select id="rate-package-selector-modal" class="seahawks-select"></select>
                    </div>
                </div>
                <div id="rate-editor-fields"></div>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <button id="rate-print-btn" class="btn">Nyomtat</button>
                <button class="btn modal-close-btn" style="font-size: 0.9rem;">Bez√°r√°s</button>
            </div>
        </div>
    </div>
    
    <div id="wiki-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Haszn√°lati √ötmutat√≥</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <h3>Bevezet√©s</h3>
                <p>Ez az alkalmaz√°s a helysz√≠ni kisz√°ll√°sok k√∂lts√©geinek gyors √©s pontos becsl√©s√©re szolg√°l. A bal oldalon tal√°lhat√≥, lenyithat√≥ panelekben adhatja meg a projekt r√©szleteit, a jobb oldalon pedig val√≥s id≈ëben k√∂vetheti a kalkul√°ci√≥ eredm√©ny√©t.</p>
                
                <h3>Fejl√©c M≈±veletek</h3>
                <p>A fels≈ë s√°vban tal√°lhat√≥ vez√©rl≈ëkkel glob√°lis be√°ll√≠t√°sokat v√©gezhet:</p>
                <ul>
                    <li><strong>√Årlista:</strong> V√°lasszon a bet√∂lt√∂tt √°rlist√°k k√∂z√ºl. A d√≠jt√©telek ideiglenesen fel√ºl√≠rhat√≥k az "√Årlist√°k" gombbal.</li>
                    <li><strong>P√©nznem:</strong> V√°ltson HUF √©s EUR k√∂z√∂tt. Az √°tv√°lt√°s az aktu√°lis √°rfolyamon t√∂rt√©nik.</li>
                    <li><strong>√Årfolyam:</strong> Az alkalmaz√°s indul√°skor automatikusan lek√©ri a legfrissebb EUR/HUF √°rfolyamot (a d√°tum a c√≠mk√©ben l√°that√≥). Ezt az √©rt√©ket b√°rmikor manu√°lisan fel√ºl√≠rhatja.</li>
                    <li><strong>Kedvezm√©ny:</strong> Adjon meg egy glob√°lis, sz√°zal√©kos kedvezm√©nyt, amelyet a rendszer a v√©g√∂sszegb≈ël von le.</li>
                    <li><strong>Vissza√°ll√≠t√°s:</strong> A gomb az √∂sszes beviteli mez≈ët t√∂rli, √©s √∫jrat√∂lti az oldalt, vissza√°ll√≠tva az eredeti d√≠jt√©teleket.</li>
                </ul>

                <h3>Adatbevitel</h3>
                <p>A kalkul√°ci√≥ alapj√°t a lenyithat√≥ panelekben megadott adatok k√©pezik. A "Ment√©s √©s bez√°r√°s" gomb csup√°n a panel bez√°r√°s√°ra szolg√°l, a bevitt adatok automatikusan √©rv√©nybe l√©pnek.</p>

                <h3>Egy√©b K√∂lts√©gek Kezel√©se</h3>
                <p>Lehet≈ës√©ge van egyedi, a standard d√≠jt√©teleken k√≠v√ºli k√∂lts√©gek hozz√°ad√°s√°ra.</p>
                <ul>
                    <li><strong>Fontos:</strong> Egy √∫j t√©tel csak a sorv√©gi <strong>z√∂ld pipa (ment√©s)</strong> gombra kattint√°s ut√°n ker√ºl be a v√©gleges kalkul√°ci√≥ba. A nem mentett t√©telek s√°rga oldals√°vval vannak megjel√∂lve.</li>
                    <li><strong>Norm√°l t√©tel:</strong> Adja meg a t√©tel nev√©t, mennyis√©g√©t, egys√©g√©t √©s a nett√≥ elad√°si √°rat.</li>
                    <li><strong>√ñnk√∂lts√©ges t√©tel:</strong> Pip√°lja be az "√ñnk√∂lts√©ges?" jel√∂l≈ën√©gyzetet. Ekkor a megadott √°r beszerz√©si √°rnak min≈ës√ºl, amelyre a rendszer r√°teszi a megadott "Haszonkulcsot" az elad√°si √°r k√©pz√©s√©hez.</li>
                    <li><strong>M√≥dos√≠t√°s:</strong> Egy m√°r mentett t√©tel b√°rmely adat√°nak m√≥dos√≠t√°sa ut√°n a t√©tel √∫jra "nem mentett" √°llapotba ker√ºl, √©s kiker√ºl a kalkul√°ci√≥b√≥l, am√≠g √∫jra el nem menti.</li>
                </ul>

                <h3>D√≠jt√©telek M√≥dos√≠t√°sa</h3>
                <p>Az "√Årlist√°k" gombra kattintva felugr√≥ ablakban a kiv√°lasztott √°rlista **b√°rmely d√≠jt√©tel√©t ideiglenesen fel√ºl√≠rhatja** az aktu√°lis kalkul√°ci√≥hoz. Ezek a v√°ltoztat√°sok nem ment≈ëdnek el, az oldal √∫jrat√∂lt√©s√©vel vissza√°llnak az eredeti √©rt√©kekre.</p>
                
                <h3>Nyomtat√°s, Export √©s N√©zetek</h3>
                 <p>Az als√≥ s√°vban h√°rom n√©zet k√∂z√ºl v√°laszthat, amelyek a jobb oldali t√°bl√°zat, a nyomtat√°si k√©p √©s az XLS export r√©szletess√©g√©t is befoly√°solj√°k:</p>
                 <ul>
                    <li><strong>Egyszer≈±:</strong> Csak a f≈ëbb kateg√≥ri√°k √©s a v√©g√∂sszegek l√°tszanak. Ide√°lis √ºgyf√©laj√°nlatokhoz.</li>
                    <li><strong>R√©szletes:</strong> Minden t√©telt megjelen√≠t mennyis√©ggel, egys√©g√°rral √©s √∂sszes√≠tett √°rral.</li>
                    <li><strong>Teljes:</strong> A r√©szletes n√©zet kieg√©sz√≠tve az √∂nk√∂lts√©gi oszloppal. Ez a n√©zet bels≈ë haszn√°latra k√©sz√ºlt, a nyomtat√°si k√©pen v√≠zjellel ell√°tva.</li>
                </ul>
                <p>Az **Export XLS** gomb egy √∫j, k√©tlapos, dinamikus Excel f√°jlt gener√°l. A "Kalkul√°ci√≥" lapon a sz√°mok f√ºggv√©nyekkel hivatkoznak a "D√≠jt√©telek" lapon tal√°lhat√≥ √©rt√©kekre, √≠gy a let√∂lt√∂tt f√°jlban is k√∂nnyen m√≥dos√≠that√≥k a d√≠jak.</p>

                <h3>Mobiln√©zet</h3>
                <p>Kisebb k√©perny≈ëk√∂n (pl. tableten vagy telefonon) az eredm√©nyt√°bl√°zat el van rejtve. A jobb als√≥ sarokban megjelen≈ë <strong>lebeg≈ë grafikon (üìä) gombbal</strong> tudja megjelen√≠teni vagy elrejteni.</p>
            </div>
             <div class="modal-footer" style="justify-content: flex-end;">
                <button class="btn modal-close-btn" style="font-size: 0.9rem;">Bez√°r√°s</button>
            </div>
        </div>
    </div>


    <script type="module">
        const ADMIN_PASSWORD = 'Kalkulator_2026';
        const APP_VERSION = "v3.3.46";

        const RATE_EDITOR_GROUPS = [
            {
                title: 'Szem√©lyi √ìrad√≠jak',
                keys: [
                    'szerelo_hetkoznap_oradij', 'szerelo_hetvege_oradij', 
                    'szerelesvezeto_hetkoznap_oradij', 'szerelesvezeto_hetvege_oradij',
                    'mernok_hetkoznap_oradij', 'mernok_hetvege_oradij'
                ]
            },
            {
                title: 'Kisz√°ll√°si √©s Kik√ºldet√©si D√≠jak',
                keys: [
                    'kiszallasi_dij_szerelo', 'kiszallasi_dij_mernok', 
                    'kikuldeles_dij_szerelo', 'kikuldeles_dij_mernok'
                ]
            },
            {
                title: 'Utaz√°s, Ell√°t√°s √©s Eszk√∂z√∂k',
                keys: [
                    'km_dij', 
                    'szallas_dij', 'szallas_szorzo', 
                    'emelogep_napidij', 'emelogep_szallitas_dij', 'emelogep_szorzo'
                ]
            }
        ];
        
        const footerHTML = `&copy; ${new Date().getFullYear()} K√∂lts√©gkalkul√°tor <span class="copyright-version">| Verzi√≥: ${APP_VERSION}</span>`;
        document.getElementById('landing-footer').innerHTML = footerHTML;
        document.getElementById('copyright-footer').innerHTML = footerHTML;

        let state = {
            rates: [], otherCosts: [], exchangeRates: {}, activeRatePackage: null,
            calculationResults: null, activeCurrency: 'HUF', config: {},
            travelTimeUnit: '√≥ra', latestExchangeRateDate: null
        };

        const D = (id) => document.getElementById(id);
        const formatCustomCurrency = (val, currencySymbol = 'Ft') => {
            const num = parseFloat(val) || 0;
            if (currencySymbol === '‚Ç¨') {
                const fixedNumStr = num.toFixed(2);
                let [integerPart, decimalPart] = fixedNumStr.split('.');
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                return `${integerPart},${decimalPart}.- ‚Ç¨`;
            }
            const str = Math.round(num).toString();
            return `${str.replace(/\B(?=(\d{3})+(?!\d))/g, ".")}.- Ft`;
        };
        
        const convertPrice = (huf, curr) => curr === 'EUR' ? huf / (parseFloat(unformatCurrencyValue(D('exchange-rate-manual').value)) || 1) : huf;
        
        const unformatCurrencyValue = (value) => {
            if (typeof value !== 'string') return value;
            return value.replace(/[^0-9,-]/g, '').replace(',', '.');
        };

        const formattedInputs = new Set();

        function formatInputField(input) {
            if (!input || !formattedInputs.has(input.id)) return;
            
            const cleanValueStr = unformatCurrencyValue(input.value);
            const value = parseFloat(cleanValueStr);

            if (isNaN(value)) {
                input.value = '';
                return;
            }

            if (input.id === 'exchange-rate-manual') {
                input.value = `${value.toFixed(2).replace('.', ',')} Ft/Eur`;
            } else if (input.id === 'discount-input' || input.dataset.fieldType === 'percentage') {
                input.value = `${value} %`;
            } else {
                const currency = state.activeCurrency;
                const options = { style: 'decimal', minimumFractionDigits: currency === 'EUR' ? 2 : 0, maximumFractionDigits: currency === 'EUR' ? 2 : 0 };
                const formatter = new Intl.NumberFormat(currency === 'EUR' ? 'de-DE' : 'hu-HU', options);
                input.value = `${formatter.format(value)} ${currency === 'EUR' ? '‚Ç¨' : 'Ft'}`;
            }
        }

        function addInputFormatting(element) {
            if (!element) return;
            formattedInputs.add(element.id);
            element.addEventListener('focus', (e) => {
                const input = e.target;
                input.value = unformatCurrencyValue(input.value);
                setTimeout(() => input.select(), 0);
            });
            element.addEventListener('blur', (e) => formatInputField(e.target));
            formatInputField(element);
        }

        async function fetchExchangeRates() {
            const cached = localStorage.getItem('exchangeRates');
            const now = new Date();
            if (cached) {
                const { timestamp, data } = JSON.parse(cached);
                if (now.getTime() - timestamp < 4 * 60 * 60 * 1000) {
                    state.exchangeRates = data; return;
                }
            }
            try {
                const end = now.toISOString().split('T')[0];
                const start = new Date(new Date().setDate(now.getDate() - 90)).toISOString().split('T')[0];
                const response = await fetch(`https://api.frankfurter.app/${start}..${end}?from=EUR&to=HUF`);
                if (!response.ok) throw new Error('API hiba');
                const data = await response.json();
                state.exchangeRates = data;
                localStorage.setItem('exchangeRates', JSON.stringify({ timestamp: new Date().getTime(), data }));
            } catch (error) {
                console.error("√Årfolyam lek√©rdez√©s sikertelen:", error);
                alert("Az √°rfolyamadatok lek√©rdez√©se nem siker√ºlt. K√©zi be√°ll√≠t√°s sz√ºks√©ges.");
            }
        }

        function setLatestExchangeRate() {
            if (state.exchangeRates && state.exchangeRates.rates) {
                const dates = Object.keys(state.exchangeRates.rates).sort();
                const latestDate = dates[dates.length - 1];
                if (latestDate && state.exchangeRates.rates[latestDate].HUF) {
                    state.latestExchangeRateDate = latestDate;
                    const rateInput = D('exchange-rate-manual');
                    rateInput.value = state.exchangeRates.rates[latestDate].HUF.toFixed(2).replace('.', ',');
                    formatInputField(rateInput);
                    D('exchange-rate-title').innerHTML = `√Årfolyam (${new Date(latestDate).toLocaleDateString('hu-HU')})`;
                }
            }
        }
        
        async function initApp() {
            try {
                D('calculation-summary-header').open = false;
                D('calculation_date').value = new Date().toISOString().split('T')[0];
                await fetchExchangeRates();
                addInputFormatting(D('exchange-rate-manual'));
                addInputFormatting(D('discount-input'));
                setLatestExchangeRate();


                const [ratesRes, labelsRes, inputsRes] = await Promise.all([
                    fetch('rates.json'), fetch('rate_key_labels.json'), fetch('input_config.json')
                ]);
                state.config = { RATE_KEY_LABELS: await labelsRes.json(), INPUT_CONFIG: await inputsRes.json() };
                state.rates = await ratesRes.json();

                renderInputs(); 
                updateRateSelectors();
                const initialPackageId = D('rate-package-select').value;
                state.activeRatePackage = state.rates.find(r => r.id === initialPackageId) || state.rates[0];
                
                setupOtherCostsList();
                calculateAndDisplay();

                // --- EVENT LISTENERS ---
                
                D('app-container').addEventListener('input', (e) => {
                    const target = e.target;
                    if (target.closest('#other-costs-list')) {
                        handleOtherCostInput(target);
                    } else if (target.name === 'print-detail') {
                        calculateAndDisplay();
                    } else if (!formattedInputs.has(target.id)) {
                        calculateAndDisplay();
                    }
                });
                
                D('app-container').addEventListener('change', (e) => {
                    const target = e.target;
                    let needsRecalculation = false;
                    
                    if (target.closest('#other-costs-list')) {
                        const index = parseInt(target.dataset.index, 10);
                        const field = target.dataset.field;
                        const item = state.otherCosts[index];
                        if (item) {
                           if (target.classList.contains('formatted-input')) {
                                item[field] = parseFloat(unformatCurrencyValue(target.value)) || 0;
                            }
                            item.isSaved = false;
                            setupOtherCostsList();
                            calculateAndDisplay();
                        }
                    } else if (formattedInputs.has(target.id)) {
                        needsRecalculation = true;
                    }
                    
                    if (needsRecalculation) {
                        calculateAndDisplay();
                    }
                });

                D('app-container').addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    const spanTarget = e.target.closest('.travel-unit-toggle');
                    
                    if (spanTarget) {
                        handleTravelUnitToggle();
                        return;
                    }

                    if (!target) return;
                    
                    if (target.classList.contains('other-cost-delete-btn')) {
                        const index = parseInt(target.dataset.index, 10);
                        state.otherCosts.splice(index, 1);
                        setupOtherCostsList();
                        calculateAndDisplay();
                    } else if (target.classList.contains('other-cost-save-btn')) {
                        const index = parseInt(target.dataset.index, 10);
                        if (state.otherCosts[index]) {
                            state.otherCosts[index].isSaved = true;
                            setupOtherCostsList();
                            calculateAndDisplay();
                        }
                    } else if (target.closest('.card-save-btn')) {
                        target.closest('details').open = false;
                    }
                });

                D('add-other-cost-btn').onclick = () => {
                    state.otherCosts.push({ description: '', amount: 0, quantity: 1, unit: '', isCostItem: false, multiplier: 30, isSaved: false });
                    setupOtherCostsList();
                };

                D('currency-select').onchange = (e) => { state.activeCurrency = e.target.value; calculateAndDisplay(); };
                D('reset-btn').onclick = () => { if(confirm("Minden beviteli mez≈ët t√∂r√∂l? A m√≥dos√≠tott √°rak is alaphelyzetbe √°llnak.")) location.reload(); };
                D('theme-switcher').onclick = () => document.body.classList.toggle('light-mode');
                D('wiki-btn').onclick = () => D('wiki-modal').style.display = 'block';
                
                D('manage-rates-btn').onclick = openRateManager;
                D('print-btn').onclick = () => handlePrint();
                D('export-xls-btn').onclick = handleExportXLS;

                const mobileResultsBtn = D('mobile-results-btn');
                const resultsPanel = D('results-panel');
                const closeMobileResultsBtn = resultsPanel.querySelector('.close-mobile-results');
                if (mobileResultsBtn) mobileResultsBtn.onclick = () => resultsPanel.classList.add('mobile-visible');
                if (closeMobileResultsBtn) closeMobileResultsBtn.onclick = () => resultsPanel.classList.remove('mobile-visible');

                document.querySelectorAll('.modal-close-btn').forEach(btn => btn.onclick = () => btn.closest('.modal').style.display = 'none');
                D('execute-print-btn').onclick = () => D('print-preview-iframe').contentWindow.print();
                
                const syncRatePackages = (newPackageId) => {
                    state.activeRatePackage = state.rates.find(r => r.id === newPackageId);
                    D('rate-package-select').value = newPackageId;
                    D('rate-package-selector-modal').value = newPackageId;
                    populateRateForm(newPackageId);
                    calculateAndDisplay();
                };

                D('rate-package-select').onchange = (e) => syncRatePackages(e.target.value);
                D('rate-package-selector-modal').onchange = (e) => syncRatePackages(e.target.value);
                D('rate-print-btn').onclick = handlePrintRateList;

                D('rate-editor-fields').addEventListener('change', (e) => {
                    const input = e.target;
                    const key = input.dataset.rateKey;
                    if (!key) return;
                    
                    const value = parseFloat(unformatCurrencyValue(input.value)) || 0;
                    const activePackageId = D('rate-package-selector-modal').value;
                    const packageToEdit = state.rates.find(r => r.id === activePackageId);

                    if (packageToEdit) {
                        if (packageToEdit.rates.fixed.hasOwnProperty(key)) {
                            packageToEdit.rates.fixed[key] = value;
                        } else if (packageToEdit.rates.overridable.hasOwnProperty(key)) {
                            packageToEdit.rates.overridable[key] = value;
                        }
                        calculateAndDisplay();
                    }
                });

            } catch (error) {
                console.error("Alkalmaz√°s inicializ√°l√°si hiba:", error);
                alert("Hiba t√∂rt√©nt az alkalmaz√°s bet√∂lt√©se k√∂zben. K√©rj√ºk, friss√≠tse az oldalt.");
            }
        }
        
        function renderInputs() {
            Object.entries(state.config.INPUT_CONFIG).forEach(([group, configs]) => {
                const container = D(`${group}-inputs`);
                if (container) {
                    container.innerHTML = '';
                    configs.forEach(config => {
                        const groupEl = document.createElement('div');
                        groupEl.className = 'form-group';
                        groupEl.innerHTML = `<label for="${config.id}">${config.label}</label>`;
                        let inputEl;
                        if (config.type === 'select') {
                            inputEl = document.createElement('select');
                            config.options.forEach(opt => inputEl.add(new Option(opt.text, opt.value)));
                        } else {
                            inputEl = document.createElement('input');
                            inputEl.type = config.type === 'text' ? 'text' : 'number';
                        }
                        inputEl.id = config.id;
                        groupEl.appendChild(inputEl);
                        container.appendChild(groupEl);
                    });
                }
            });
        }
        
        function getInputs(){
            const inputs = {};
            document.querySelectorAll('#app-container input, #app-container select').forEach(el => {
                if (el.id) {
                    const value = formattedInputs.has(el.id) ? unformatCurrencyValue(el.value) : el.value;
                    if (el.type === 'number' || el.type === 'checkbox' || el.classList.contains('formatted-input')) {
                       inputs[el.id] = (el.type === 'checkbox') ? el.checked : (parseFloat(value) || 0);
                    } else {
                       inputs[el.id] = value;
                    }
                }
            });
            return inputs;
        }

        function calculateCosts() {
            const inputs = getInputs(); 
            const pkg = state.activeRatePackage;
            if (!pkg || !pkg.rates) return { totalHuf: 0, totalCostHuf: 0, breakdown: [], hasCostItems: false };
            const rates = { ...pkg.rates.fixed, ...pkg.rates.overridable };

            let breakdown = [], totalSell = 0, totalCost = 0, hasCostItems = false;
            
            const addItem = (label, quantity, unit, sellPrice, costPrice, isCostItem) => {
                if (quantity > 0 && sellPrice > 0) {
                    const totalSellPrice = quantity * sellPrice;
                    const totalCostPrice = quantity * costPrice;
                    breakdown.push({ label, quantity, unit, unitPriceHuf: sellPrice, totalHuf: totalSellPrice, costPriceHuf: costPrice, totalCostHuf: totalCostPrice, isCostItem });
                    totalSell += totalSellPrice;
                    if (isCostItem) {
                        totalCost += totalCostPrice;
                        hasCostItems = true;
                    }
                }
            };

            const sN = inputs.szerelo_munkanap || 0, sF = inputs.szerelo_fo || 0, sH = inputs.szerelo_munkaora || 0, sW = inputs.szerelo_hetvegi_nap || 0;
            const mN = inputs.mernok_munkanap || 0, mF = inputs.mernok_fo || 0, mH = inputs.mernok_munkaora || 0, mW = inputs.mernok_hetvegi_nap || 0;
            const sWd = sN - sW; const mWd = mN - mW;

            if (mF > 0 && mN > 0) {
                addItem('M√©rn√∂k (h√©tk√∂znap)', mF * mWd * mH, '√≥ra', rates.mernok_hetkoznap_oradij, rates.mernok_hetkoznap_oradij, false);
                addItem('M√©rn√∂k (h√©tv√©ge)', mF * mW * mH, '√≥ra', rates.mernok_hetvege_oradij, rates.mernok_hetvege_oradij, false);
            }
            if (sF > 0 && sN > 0) {
                const foreman_needed_wd = Math.max(0, sWd - mWd);
                const foreman_needed_we = Math.max(0, sW - mW);
                addItem('Szerel√©svezet≈ë (h√©tk√∂znap)', foreman_needed_wd * sH, '√≥ra', rates.szerelesvezeto_hetkoznap_oradij, rates.szerelesvezeto_hetkoznap_oradij, false);
                addItem('Szerel√©svezet≈ë (h√©tv√©ge)', foreman_needed_we * sH, '√≥ra', rates.szerelesvezeto_hetvege_oradij, rates.szerelesvezeto_hetvege_oradij, false);
                addItem('Szerel≈ë (h√©tk√∂znap)', (sF * sWd * sH) - (foreman_needed_wd * sH), '√≥ra', rates.szerelo_hetkoznap_oradij, rates.szerelo_hetkoznap_oradij, false);
                addItem('Szerel≈ë (h√©tv√©ge)', (sF * sW * sH) - (foreman_needed_we * sH), '√≥ra', rates.szerelo_hetvege_oradij, rates.szerelo_hetvege_oradij, false);
            }
            if(inputs.location_type === 'kulfold'){
                addItem('Kik√ºldet√©s - Szerel≈ë', sF * sN, 'nap', rates.kikuldeles_dij_szerelo, rates.kikuldeles_dij_szerelo, true);
                addItem('Kik√ºldet√©s - M√©rn√∂k', mF * mN, 'nap', rates.kikuldeles_dij_mernok, rates.kikuldeles_dij_mernok, true);
            }
            
            let travelTime = inputs.utazas_ido_ora || 0;
            if (state.travelTimeUnit === 'perc') travelTime /= 60;
            
            addItem('Kisz√°ll√°si d√≠j - Szerel≈ë', travelTime * 2 * (inputs.utazas_odautak_szama_szerelo || 0) * sF, '√≥ra', rates.kiszallasi_dij_szerelo, rates.kiszallasi_dij_szerelo, false);
            addItem('Kisz√°ll√°si d√≠j - M√©rn√∂k', travelTime * 2 * (inputs.utazas_odautak_szama_mernok || 0) * mF, '√≥ra', rates.kiszallasi_dij_mernok, rates.kiszallasi_dij_mernok, false);
            addItem('J√°rm≈± km d√≠j', (inputs.utazas_tavolsag_km || 0) * 2 * ((inputs.utazas_odautak_szama_szerelo || 0) * (inputs.utazas_jarmuvek_szama_szerelo || 0) + (inputs.utazas_odautak_szama_mernok || 0) * (inputs.utazas_jarmuvek_szama_mernok || 0)), 'km', rates.km_dij, rates.km_dij, false);
            
            addItem('Sz√°ll√°s k√∂lts√©g', (inputs.szerelo_szallas_ejszaka || 0) * sF + (inputs.mernok_szallas_ejszaka || 0) * mF, '√©j', rates.szallas_dij * (1 + rates.szallas_szorzo / 100), rates.szallas_dij, true);

            addItem('Emel≈ëg√©p napid√≠j', (inputs.emelogep_db || 0) * (inputs.emelogep_napok || 0), 'nap', rates.emelogep_napidij * (1 + rates.emelogep_szorzo / 100), rates.emelogep_napidij, true);
            addItem('Emel≈ëg√©p sz√°ll√≠t√°s', (inputs.emelogep_szallitasok || 0) * 2, 'alk', rates.emelogep_szallitas_dij * (1 + rates.emelogep_szorzo / 100), rates.emelogep_szallitas_dij, true);
            
            state.otherCosts.forEach(c => {
                if (c.amount > 0 && c.description) {
                    const cost = c.amount;
                    const sell = c.isCostItem ? cost * (1 + (c.multiplier / 100)) : cost;
                    addItem(c.description, c.quantity || 1, c.unit || 'db', sell, cost, c.isCostItem);
                }
            });

            return { totalHuf: totalSell, totalCostHuf: totalCost, breakdown, hasCostItems };
        }

        function calculateAndDisplay(){
            state.calculationResults = calculateCosts();
            const inputs = getInputs();
            const { breakdown, totalHuf, totalCostHuf, hasCostItems } = state.calculationResults;
            const tbody = D('breakdown-body'), thead = D('breakdown-head'), tfoot = D('breakdown-foot');
            const currency = state.activeCurrency, symbol = currency === 'EUR' ? '‚Ç¨' : 'Ft';
            const discount = inputs['discount-input'] || 0;
            const detailLevel = document.querySelector('input[name="print-detail"]:checked').value;
            
            D('calculation-summary-header-content').innerHTML = `
                <div class="summary-title">Kisz√°ll√°s kalkul√°ci√≥</div>
                <div class="summary-col">
                    <p><strong>Aj√°nlatsz√°m:</strong> ${inputs.offer_number || '-'}</p>
                    <p><strong>Projektsz√°m:</strong> ${inputs.project_number || '-'}</p>
                    <p><strong>D√°tum:</strong> ${new Date(inputs.calculation_date).toLocaleDateString('hu-HU')}</p>
                </div>
                <div class="summary-col">
                    <p><strong>Megrendel≈ë:</strong> ${inputs.customer || '-'}</p>
                    <p><strong>Projekt neve:</strong> ${inputs.project_name || '-'}</p>
                    <p><strong>K√©sz√≠t≈ë:</strong> ${inputs.creator_name || '-'}</p>
                </div>`;

            tbody.innerHTML = thead.innerHTML = tfoot.innerHTML = '';
            const showCost = hasCostItems && detailLevel === 'internal';

            let headerHtml = '';
            if (detailLevel === 'simple') {
                headerHtml = '<tr><th>K√∂lts√©gnem</th><th style="text-align:right;">√ñsszesen</th></tr>';
            } else {
                headerHtml = '<tr><th>K√∂lts√©gnem</th><th style="text-align:right;">Menny.</th><th>Egys.</th><th style="text-align:right;">Egys√©g√°r</th>';
                if (showCost) headerHtml += '<th style="text-align:right;">√ñnk√∂lts√©g</th>';
                headerHtml += '<th style="text-align:right;">√ñsszesen</th></tr>';
            }
            thead.innerHTML = headerHtml;
            
            breakdown.forEach(item => {
                const row = tbody.insertRow();
                let cells = '';
                if (detailLevel === 'simple') {
                    cells = `<td>${item.label}</td><td style="text-align:right;">${formatCustomCurrency(convertPrice(item.totalHuf, currency), symbol)}</td>`;
                } else {
                    cells = `<td>${item.label}</td><td style="text-align:right;">${item.quantity.toLocaleString('hu-HU')}</td><td style="text-align:center;">${item.unit}</td><td style="text-align:right;">${formatCustomCurrency(convertPrice(item.unitPriceHuf, currency), symbol)}</td>`;
                    if(showCost) {
                        cells += `<td style="text-align:right;">${item.isCostItem ? formatCustomCurrency(convertPrice(item.totalCostHuf, currency), symbol) : '-'}</td>`;
                    }
                    cells += `<td style="text-align:right;">${formatCustomCurrency(convertPrice(item.totalHuf, currency), symbol)}</td>`;
                }
                row.innerHTML = cells;
            });

            const totalSellFinal = convertPrice(totalHuf, currency);
            const colspanForLabel = detailLevel === 'simple' ? 1 : (showCost ? 5 : 4);
            
            let footerHtml = ``;
            if (showCost) {
                const totalCostFinal = convertPrice(totalCostHuf, currency);
                footerHtml += `<tr><td colspan="${colspanForLabel}" style="text-align:right; font-weight:bold;">√ñnk√∂lts√©g √∂sszesen</td><td style="text-align:right; font-weight:bold;">${formatCustomCurrency(totalCostFinal, symbol)}</td></tr>`;
            }
            footerHtml += `<tr style="border-top: 2px solid var(--accent-primary);"><td colspan="${colspanForLabel}" style="text-align:right; font-weight:bold;">V√©g√∂sszeg (${currency})</td><td style="text-align:right; font-weight:bold;">${formatCustomCurrency(totalSellFinal, symbol)}</td></tr>`;
            
            if (discount > 0) {
                const discountedTotal = totalSellFinal * (1 - discount/100);
                footerHtml += `<tr class="discount-row"><td colspan="${colspanForLabel}" style="text-align:right;">Engedm√©ny (${discount}%)</td><td style="text-align:right;">- ${formatCustomCurrency(totalSellFinal - discountedTotal, symbol)}</td></tr>`;
                footerHtml += `<tr class="success-row"><td colspan="${colspanForLabel}" style="text-align:right;">Kedvezm√©nyes v√©g√∂sszeg</td><td style="text-align:right;">${formatCustomCurrency(discountedTotal, symbol)}</td></tr>`;
            }
            tfoot.innerHTML = footerHtml;

            formattedInputs.forEach(id => {
                const el = D(id);
                if (el && document.activeElement !== el) {
                    formatInputField(el);
                }
            });
        }
        
        function openRateManager() { 
            D('rate-modal').style.display = 'block'; 
            D('rate-package-selector-modal').value = state.activeRatePackage.id;
            populateRateForm(state.activeRatePackage.id);
        }
        
        function updateRateSelectors(selectedId) {
            const mainSelector = D('rate-package-select');
            const modalSelector = D('rate-package-selector-modal');
            const currentVal = selectedId || mainSelector.value || (state.rates[0] ? state.rates[0].id : '');
            
            mainSelector.innerHTML = ''; 
            modalSelector.innerHTML = ''; 
            state.rates.forEach(p => {
                mainSelector.add(new Option(p.name, p.id));
                modalSelector.add(new Option(p.name, p.id));
            });
            
            if (state.rates.some(r => r.id === currentVal)) {
                mainSelector.value = currentVal;
                modalSelector.value = currentVal;
            } else if (mainSelector.options.length > 0) {
                mainSelector.value = mainSelector.options[0].value;
                modalSelector.value = modalSelector.options[0].value;
            }
        }

        function populateRateForm(packageId) {
            const pkg = state.rates.find(r => r.id === packageId); if (!pkg) return;
            const fieldsContainer = D('rate-editor-fields');
            fieldsContainer.innerHTML = '';
            const allRates = { ...pkg.rates.fixed, ...pkg.rates.overridable };
            const verticalSpacerKeys = ['kikuldeles_dij_szerelo', 'szallas_dij', 'emelogep_napidij'];
            
            RATE_EDITOR_GROUPS.forEach(group => {
                const titleEl = document.createElement('h3');
                titleEl.className = 'rate-group-title';
                titleEl.textContent = group.title;
                fieldsContainer.appendChild(titleEl);

                group.keys.forEach(key => {
                    if (state.config.RATE_KEY_LABELS[key] && allRates.hasOwnProperty(key)) {
                        const labelText = state.config.RATE_KEY_LABELS[key];
                        const value = allRates[key] || 0;
                        const isPercentage = key.includes('_szorzo');
                        const fieldType = isPercentage ? 'percentage' : 'currency';
                        
                        if (key === 'mernok_hetkoznap_oradij') {
                            const separator = document.createElement('div');
                            separator.className = 'rate-item-separator';
                            fieldsContainer.appendChild(separator);
                        }

                        if (verticalSpacerKeys.includes(key)) {
                            const vSpacer = document.createElement('div');
                            vSpacer.className = 'rate-item-vertical-spacer';
                            fieldsContainer.appendChild(vSpacer);
                        }
                        
                        const label = document.createElement('label');
                        label.htmlFor = `rate-edit-${key}`;
                        label.textContent = labelText;
                        fieldsContainer.appendChild(label);
                        
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.id = `rate-edit-${key}`;
                        input.className = 'formatted-input';
                        input.dataset.rateKey = key;
                        input.dataset.fieldType = fieldType;
                        input.value = value;
                        fieldsContainer.appendChild(input);
                        
                        const rightSpacer = document.createElement('span');
                        fieldsContainer.appendChild(rightSpacer);

                        addInputFormatting(input);
                    }
                });
            });
        }

        function handlePrint(isRateList = false, pkg) {
            const iframe = D('print-preview-iframe');
            const inputs = getInputs();
            let printableHtml;
            let docTitle = "Kalkul√°ci√≥";

            if (isRateList && pkg) {
                printableHtml = getRateListPrintableHtml(pkg);
                docTitle = `Arlista-${pkg.name}`;
            } else {
                const detailLevel = document.querySelector('input[name="print-detail"]:checked').value;
                printableHtml = getPrintableHtml(detailLevel, inputs, state.calculationResults);
                const offerNum = inputs.offer_number || "X";
                const dateStr = inputs.calculation_date || new Date().toISOString().split('T')[0];
                docTitle = `${offerNum}-Kalk-${dateStr}`;
            }
            
            document.title = docTitle;
            iframe.srcdoc = printableHtml;
            iframe.onload = () => { iframe.contentWindow.scrollTo(0, 0); };
            D('print-preview-modal').style.display = 'block';
        }
        
        function handlePrintRateList() {
            const pkgId = D('rate-package-selector-modal').value;
            const pkg = state.rates.find(r => r.id === pkgId);
            if (pkg) handlePrint(true, pkg);
        }

        function getPrintableHtml(detailLevel, inputs, calcResults) {
            const { breakdown, totalHuf, totalCostHuf, hasCostItems } = calcResults;
            const currency = state.activeCurrency, symbol = currency === 'EUR' ? '‚Ç¨' : 'Ft';
            const discount = inputs['discount-input'] || 0;
            const totalSellFinal = convertPrice(totalHuf, currency);
            const discountedTotal = totalSellFinal * (1 - discount / 100);
            const showCost = hasCostItems && detailLevel === 'internal';

            const colspanForLabel = detailLevel === 'simple' ? 1 : (showCost ? 5 : 4);
            
            let tableRows = '';
            const headerCols = detailLevel === 'simple' ? '<th style="text-align:right;">√ñsszesen</th>' : `<th style="text-align:right;">Mennyis√©g</th><th style="text-align:right;">Egys√©g√°r</th>${showCost ? '<th style="text-align:right;">√ñnk√∂lts√©g</th>' : ''}<th style="text-align:right;">√ñsszesen</th>`;
            breakdown.forEach(item => {
                if (detailLevel === 'simple') {
                    tableRows += `<tr><td>${item.label}</td><td style="text-align:right;">${formatCustomCurrency(convertPrice(item.totalHuf, currency), symbol)}</td></tr>`;
                } else {
                    let cells = `<td>${item.label}</td><td style="text-align:right;">${item.quantity.toLocaleString('hu-HU')} ${item.unit}</td><td style="text-align:right;">${formatCustomCurrency(convertPrice(item.unitPriceHuf, currency), symbol)}</td>`;
                    if(showCost) {
                        cells += `<td style="text-align:right;">${item.isCostItem ? formatCustomCurrency(convertPrice(item.totalCostHuf, currency), symbol) : '-'}</td>`;
                    }
                    cells += `<td style="text-align:right;">${formatCustomCurrency(convertPrice(item.totalHuf, currency), symbol)}</td>`;
                    tableRows += `<tr>${cells}</tr>`;
                }
            });
            
            let footerHtml = '';
            if (showCost) {
                const totalCostFinal = convertPrice(totalCostHuf, currency);
                footerHtml += `<tr class="summary-line"><td colspan="${colspanForLabel}" style="text-align:right; font-weight:bold;">√ñnk√∂lts√©g √∂sszesen:</td><td style="text-align:right; font-weight:bold;">${formatCustomCurrency(totalCostFinal, symbol)}</td></tr>`;
            }

            const printHeader = `<div style="display:flex; justify-content:space-between; width:100%; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
                <div style="flex:1;">
                    <p><strong>Aj√°nlatsz√°m:</strong> ${inputs.offer_number || 'nincs megadva'}</p><p><strong>Projektsz√°m:</strong> ${inputs.project_number || 'nincs megadva'}</p><p><strong>D√°tum:</strong> ${new Date(inputs.calculation_date).toLocaleDateString('hu-HU')}</p>
                </div><div style="flex:1; text-align:right;">
                    <p><strong>Megrendel≈ë:</strong> ${inputs.customer || 'nincs megadva'}</p><p><strong>Projekt neve:</strong> ${inputs.project_name || 'nincs megadva'}</p><p><strong>K√©sz√≠t≈ë:</strong> ${inputs.creator_name || 'nincs megadva'}</p>
                </div></div>`;
            
            let summaryHtml = `<div style="padding: 10px; margin-bottom: 20px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 4px;">`;
            summaryHtml += `<p><strong>Feladat:</strong> ${inputs.feladat || 'Nincs megadva'}</p>`;
            if (inputs.szerelo_fo > 0) { 
                const hoursText = detailLevel === 'internal' ? `, napi ${inputs.szerelo_munkaora} √≥r√°ban` : '';
                summaryHtml += `<p>${inputs.szerelo_fo} szerel≈ë, ${inputs.szerelo_munkanap} munkanap (ebb≈ël ${inputs.szerelo_hetvegi_nap} h√©tv√©ge)${hoursText}.</p>`; 
            }
            if (inputs.mernok_fo > 0) { 
                const hoursText = detailLevel === 'internal' ? `, napi ${inputs.mernok_munkaora} √≥r√°ban` : '';
                summaryHtml += `<p>${inputs.mernok_fo} m√©rn√∂k, ${inputs.mernok_munkanap} munkanap (ebb≈ël ${inputs.mernok_hetvegi_nap} h√©tv√©ge)${hoursText}.</p>`; 
            }
            summaryHtml += `</div>`;
            const isInternal = detailLevel === 'internal';
            const watermarkHtml = isInternal ? `<div class="watermark">BELS≈ê HASZN√ÅLATRA</div>` : "";
            const thStyle = isInternal ? 'background-color: rgba(242, 242, 242, 0.7);' : 'background-color: #f2f2f2;';
            const footerPrintHTML = `<div class="print-footer"><hr><p>${new Date().getFullYear()} &copy; K√∂lts√©gkalkul√°tor | Verzi√≥: ${APP_VERSION}</p><p>URL: https://kuutio-hub.github.io/Kiszallas/</p></div>`;

            return `<!DOCTYPE html><html lang="hu"><head><meta charset="UTF-8"><title>${inputs.offer_number || 'Aj√°nlat'}</title><style>
                @font-face{font-family:'DejaVuSans';src:url('https://cdn.jsdelivr.net/gh/dejavu-fonts/dejavu-fonts-ttf/ttf/DejaVuSans.ttf') format('truetype');}
                @page{size:A4;margin:15mm 20mm;}
                body{position:relative;font-family:'DejaVuSans',sans-serif;font-size:10px;color:#333; background-color:#ffffff!important; padding: 10px;}
                h1{text-align:center;} p{margin:2px 0;}
                .print-wrapper{position:relative;z-index:1;}
                table{width:100%;border-collapse:collapse;margin-top:20px;}
                th,td{border:1px solid #ccc;padding:6px;text-align:left;}
                th{${thStyle}}
                .summary-table{margin-top:20px;width:60%;margin-left:auto;border:none;}
                .summary-table td{border:none; padding: 4px 6px;}
                .summary-line { border-top: 1.5px solid #333 !important; }
                .discount-highlight { color: #d32f2f; font-weight: bold; }
                .watermark, .print-footer { display: none; }
                @media print {
                    .watermark { display: block; position:absolute; top:40vh; left:0; right:0; text-align:center; width:100%; transform:rotate(-45deg); font-size:8vw; color:rgba(128,0,0,0.08); z-index:0; font-weight:bold; pointer-events:none; }
                    .print-footer { display: block; position:fixed; bottom:10mm; left:20mm; right:20mm; text-align:center; font-size:9px; color:#666; }
                    .print-footer hr { border: 0; border-top: 1px solid #ccc; margin-bottom: 5px; }
                    .print-footer p { margin: 2px 0; }
                }
            </style></head><body>${watermarkHtml}<div class="print-wrapper">${printHeader}${summaryHtml}<table><thead><tr><th>Le√≠r√°s</th>${headerCols}</tr></thead><tbody>${tableRows}</tbody></table><table class="summary-table"><tbody>${footerHtml}<tr class="${!showCost ? 'summary-line' : ''}"><td colspan="${colspanForLabel}" style="text-align:right;">Nett√≥ v√©g√∂sszeg:</td><td style="text-align:right;">${formatCustomCurrency(totalSellFinal,symbol)}</td></tr>${discount>0?`<tr class="discount-highlight"><td colspan="${colspanForLabel}" style="text-align:right;">Kedvezm√©ny (${discount}%):</td><td style="text-align:right;">- ${formatCustomCurrency(totalSellFinal-discountedTotal,symbol)}</td></tr><tr class="summary-line"><td colspan="${colspanForLabel}" style="text-align:right;"><strong>Kedvezm√©nyes nett√≥ v√©g√∂sszeg:</strong></td><td style="text-align:right;"><strong>${formatCustomCurrency(discountedTotal,symbol)}</strong></td></tr>`:''}</tbody></table></div>${footerPrintHTML}</body></html>`;
        }

        function getRateListPrintableHtml(pkg) {
            const allRates = { ...pkg.rates.fixed, ...pkg.rates.overridable };
            let tableRows = '';

            RATE_EDITOR_GROUPS.forEach(group => {
                tableRows += `<tr><td colspan="2" style="background-color: #f2f2f2; font-weight: bold; text-align: left; padding-left: 10px;">${group.title}</td></tr>`;
                group.keys.forEach(key => {
                     if (allRates.hasOwnProperty(key) && !key.endsWith('_szorzo')) {
                        const label = state.config.RATE_KEY_LABELS[key] || key;
                        const value = allRates[key];
                        const formattedValue = formatCustomCurrency(value, 'Ft');
                        tableRows += `<tr><td style="padding-left: 20px;">${label}</td><td style="text-align:right;">${formattedValue}</td></tr>`;
                     }
                });
            });

            const title = `√Årlista: ${pkg.name}`;
            const footerPrintHTML = `<div class="print-footer"><hr><p>${new Date().getFullYear()} &copy; K√∂lts√©gkalkul√°tor | Verzi√≥: ${APP_VERSION}</p><p>URL: https://kuutio-hub.github.io/Kiszallas/</p></div>`;
            
            return `<!DOCTYPE html><html lang="hu"><head><meta charset="UTF-8"><title>${title}</title><style>
                @font-face{font-family:'DejaVuSans';src:url('https://cdn.jsdelivr.net/gh/dejavu-fonts/dejavu-fonts-ttf/ttf/DejaVuSans.ttf') format('truetype');}
                @page{size:A4;margin:20mm;}
                body{font-family:'DejaVuSans',sans-serif;font-size:10px;color:#333; background-color: #ffffff !important; padding: 20px;}
                table{width:100%;border-collapse:collapse;margin-top:20px;}
                th,td{border:1px solid #ccc;padding:8px;text-align:left;}
                th{background-color:#f2f2f2;}
                .print-footer { display: none; }
                @media print {
                    .print-footer { display: block; position:fixed; bottom:10mm; left:20mm; right:20mm; text-align:center; font-size:9px; color:#666; }
                    .print-footer hr { border: 0; border-top: 1px solid #ccc; margin-bottom: 5px; }
                    .print-footer p { margin: 2px 0; }
                }
            </style></head><body><h1>${title}</h1><p><strong>D√°tum:</strong> ${new Date().toLocaleDateString('hu-HU')}</p><table><thead><tr><th>Megnevez√©s</th><th style="text-align:right;">√ârt√©k</th></tr></thead><tbody>${tableRows}</tbody></table>${footerPrintHTML}</body></html>`;
        }

        function setupOtherCostsList() {
            const container = D('other-costs-list');
            container.innerHTML = state.otherCosts.map((item, index) => {
                const amountLabel = item.isCostItem ? '√ñnk√∂lts√©g (HUF)' : '√År (HUF)';
                
                const costToggleHtml = `
                    <div class="form-group is-cost-item-group">
                        <input type="checkbox" id="is-cost-item-${index}" data-index="${index}" data-field="isCostItem" ${item.isCostItem ? 'checked' : ''}>
                        <label for="is-cost-item-${index}">√ñnk√∂lts√©ges?</label>
                    </div>
                    ${item.isCostItem ? `
                    <div class="form-group multiplier">
                        <label>Haszonkulcs (%)</label>
                        <input type="text" data-index="${index}" data-field="multiplier" value="${item.multiplier}" class="formatted-input" data-field-type="percentage">
                    </div>` : ''}
                `;

                const itemHtml = `
                <div class="other-cost-item ${!item.isSaved ? 'unsaved' : ''}">
                    <div class="other-cost-row-1">
                        <div class="form-group description">
                            <label>Le√≠r√°s</label>
                            <input type="text" data-index="${index}" data-field="description" value="${item.description}">
                        </div>
                    </div>
                    <div class="other-cost-row-2">
                        <div class="form-group quantity"><label>Menny.</label><input type="number" data-index="${index}" data-field="quantity" value="${item.quantity}"></div>
                        <div class="form-group unit"><label>Egys√©g</label><input type="text" data-index="${index}" data-field="unit" value="${item.unit}" placeholder="db"></div>
                        <div class="form-group amount"><label>${amountLabel}</label><input type="text" data-index="${index}" data-field="amount" value="${item.amount}" class="formatted-input" data-field-type="currency"></div>
                        <div class="cost-toggle-container">${costToggleHtml}</div>
                         <div class="other-cost-actions">
                            <button class="other-cost-action-btn save other-cost-save-btn" data-index="${index}" title="Ment√©s">
                                <svg fill="#69BE28" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            </button>
                            <button class="other-cost-action-btn delete other-cost-delete-btn" data-index="${index}" title="T√∂rl√©s">
                                 <svg fill="#9B2C2C" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                            </button>
                        </div>
                    </div>
                </div>`;
                return itemHtml;
            }).join('');
            
            container.querySelectorAll('.formatted-input').forEach(addInputFormatting);
        }

        function handleOtherCostInput(target) {
            const index = parseInt(target.dataset.index, 10);
            const field = target.dataset.field;
            const item = state.otherCosts[index];
            if (!item) return;

            if (target.classList.contains('formatted-input')) {
                // Blur/change will update value
            } else {
                item[field] = target.type === 'checkbox' ? target.checked : (target.type === 'number' ? parseFloat(target.value) || 0 : target.value);
            }
            
            if (item.isSaved) {
                item.isSaved = false;
            }
            
            if (field === 'isCostItem') {
                setupOtherCostsList();
            } else {
                 const itemElement = target.closest('.other-cost-item');
                 if(itemElement) itemElement.classList.add('unsaved');
            }
            calculateAndDisplay();
        }
        
        function handleTravelUnitToggle() {
            const input = D('utazas_ido_ora');
            const label = document.querySelector('label[for="utazas_ido_ora"]');
            if (!input || !label) return;
            
            let currentValue = parseFloat(input.value) || 0;

            if (state.travelTimeUnit === '√≥ra') {
                state.travelTimeUnit = 'perc';
                const newValue = Math.round(currentValue * 60);
                input.value = newValue;
                label.innerHTML = `Utaz√°si id≈ë (<span class="travel-unit-toggle">perc</span>, oda)`;
            } else {
                state.travelTimeUnit = '√≥ra';
                const newValue = (currentValue / 60).toFixed(2);
                input.value = newValue;
                label.innerHTML = `Utaz√°si id≈ë (<span class="travel-unit-toggle">√≥ra</span>, oda)`;
            }
            calculateAndDisplay();
        }

        function handleExportXLS() {
            const inputs = getInputs();
            const { breakdown, totalHuf, totalCostHuf, hasCostItems } = state.calculationResults;
            const pkg = state.activeRatePackage;
            if (!pkg) return;
            const allRates = { ...pkg.rates.fixed, ...pkg.rates.overridable };
            const detailLevel = document.querySelector('input[name="print-detail"]:checked').value;
            const showCost = hasCostItems && detailLevel === 'internal';

            const wb = XLSX.utils.book_new();
            const HUF_FORMAT = '#,##0" Ft"';

            // --- 1. D√çJT√âTELEK MUNKALAP ---
            const rateCellMap = {};
            const rates_ws_data = [["Azonos√≠t√≥", "Megnevez√©s", "√ârt√©k"]];
            let rateRowIdx = 1;
            Object.entries(allRates).forEach(([key, value]) => {
                const label = state.config.RATE_KEY_LABELS[key] || key;
                rates_ws_data.push([key, label, value]);
                rateCellMap[key] = `D√≠jt√©telek!$C$${rateRowIdx + 1}`;
                rateRowIdx++;
            });
            const ws_rates = XLSX.utils.aoa_to_sheet(rates_ws_data);
            ws_rates["!cols"] = [{ wch: 30 }, { wch: 40 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws_rates, "D√≠jt√©telek");


            // --- 2. KALKUL√ÅCI√ì MUNKALAP ---
            const ws_calc = XLSX.utils.aoa_to_sheet([]); // Kezd√©s √ºres lappal
            const inputCellMap = {};
            let calcRowIdx = 0;

            const addCalcRow = (data, isHeader = false) => {
                XLSX.utils.sheet_add_aoa(ws_calc, [data], { origin: calcRowIdx });
                if (isHeader) {
                    // Itt lehetne form√°z√°st hozz√°adni, ha a SheetJS Community verzi√≥ t√°mogatn√° jobban
                }
                calcRowIdx++;
            };

            // Fejl√©c
            addCalcRow(["Aj√°nlatsz√°m:", inputs.offer_number || '-']);
            addCalcRow(["Projektsz√°m:", inputs.project_number || '-']);
            addCalcRow(["Megrendel≈ë:", inputs.customer || '-']);
            calcRowIdx++;

            // Beviteli adatok
            addCalcRow(["Beviteli Adatok"], true);
            Object.values(state.config.INPUT_CONFIG).flat().forEach(config => {
                const label = config.label.replace(/<[^>]*>?/gm, '');
                const value = parseFloat(unformatCurrencyValue(inputs[config.id])) || 0;
                addCalcRow([label, value]);
                inputCellMap[config.id] = `$B$${calcRowIdx}`;
            });
            calcRowIdx++;

            // Kalkul√°ci√≥s t√°bl√°zat
            addCalcRow(["T√©telek", "Mennyis√©g", "Egys√©g", "Egys√©g√°r", "√ñnk√∂lts√©gi √År", "Aj√°nlati √År"], true);
            const firstCalcRow = calcRowIdx;

            const addFormulaRow = (label, qtyFormula, unit, unitPriceFormula, costPriceFormula) => {
                const r = calcRowIdx;
                const qtyCellRef = XLSX.utils.encode_cell({r, c: 1});
                const unitPriceCellRef = XLSX.utils.encode_cell({r, c: 3});

                XLSX.utils.sheet_add_aoa(ws_calc, [[label]], { origin: {r, c:0} });
                ws_calc[qtyCellRef] = { t: 'n', f: qtyFormula, z: '#,##0.00' };
                XLSX.utils.sheet_add_aoa(ws_calc, [[unit]], { origin: {r, c:2} });
                ws_calc[XLSX.utils.encode_cell({r,c:3})] = { t: 'n', f: unitPriceFormula, z: HUF_FORMAT };
                ws_calc[XLSX.utils.encode_cell({r,c:4})] = { t: 'n', f: costPriceFormula, z: HUF_FORMAT };
                ws_calc[XLSX.utils.encode_cell({r,c:5})] = { t: 'n', f: `=${qtyCellRef}*${unitPriceCellRef}`, z: HUF_FORMAT };
                calcRowIdx++;
            };

            // Formul√°k defini√°l√°sa
            const sF = inputCellMap.szerelo_fo, sH = inputCellMap.szerelo_munkaora, sN = inputCellMap.szerelo_munkanap, sW = inputCellMap.szerelo_hetvegi_nap;
            const sSz = inputCellMap.szerelo_szallas_ejszaka, sO = inputCellMap.utazas_odautak_szama_szerelo, sJ = inputCellMap.utazas_jarmuvek_szama_szerelo;
            const mF = inputCellMap.mernok_fo, mH = inputCellMap.mernok_munkaora, mN = inputCellMap.mernok_munkanap, mW = inputCellMap.mernok_hetvegi_nap;
            const mSz = inputCellMap.mernok_szallas_ejszaka, mO = inputCellMap.utazas_odautak_szama_mernok, mJ = inputCellMap.utazas_jarmuvek_szama_mernok;
            const tav = inputCellMap.utazas_tavolsag_km, ido = inputCellMap.utazas_ido_ora;
            const eDb = inputCellMap.emelogep_db, eN = inputCellMap.emelogep_napok, eSz = inputCellMap.emelogep_szallitasok;
            const sWd = `(${sN}-${sW})`, mWd = `(${mN}-${mW})`, fWd = `MAX(0,${sWd}-${mWd})`, fWe = `MAX(0,${sW}-${mW})`;
            const travelTime = state.travelTimeUnit === 'perc' ? `(${ido}/60)` : ido;

            // T√©telek hozz√°ad√°sa formul√°kkal
            addFormulaRow("M√©rn√∂k √≥rad√≠j (h√©tk√∂znap)", `=${mF}*${mWd}*${mH}`, "√≥ra", `=${rateCellMap.mernok_hetkoznap_oradij}`, "0");
            addFormulaRow("M√©rn√∂k √≥rad√≠j (h√©tv√©ge)", `=${mF}*${mW}*${mH}`, "√≥ra", `=${rateCellMap.mernok_hetvege_oradij}`, "0");
            addFormulaRow("Szerel√©svezet≈ë √≥rad√≠j (h√©tk√∂znap)", `=${fWd}*${sH}`, "√≥ra", `=${rateCellMap.szerelesvezeto_hetkoznap_oradij}`, "0");
            addFormulaRow("Szerel√©svezet≈ë √≥rad√≠j (h√©tv√©ge)", `=${fWe}*${sH}`, "√≥ra", `=${rateCellMap.szerelesvezeto_hetvege_oradij}`, "0");
            addFormulaRow("Szerel≈ë √≥rad√≠j (h√©tk√∂znap)", `=(${sF}*${sWd}*${sH})-(${fWd}*${sH})`, "√≥ra", `=${rateCellMap.szerelo_hetkoznap_oradij}`, "0");
            addFormulaRow("Szerel≈ë √≥rad√≠j (h√©tv√©ge)", `=(${sF}*${sW}*${sH})-(${fWe}*${sH})`, "√≥ra", `=${rateCellMap.szerelo_hetvege_oradij}`, "0");
            addFormulaRow("Kik√ºldet√©s - Szerel≈ë", `=${sF}*${sN}`, "nap", `=${rateCellMap.kikuldeles_dij_szerelo}`, `=${rateCellMap.kikuldeles_dij_szerelo}`);
            addFormulaRow("Kik√ºldet√©s - M√©rn√∂k", `=${mF}*${mN}`, "nap", `=${rateCellMap.kikuldeles_dij_mernok}`, `=${rateCellMap.kikuldeles_dij_mernok}`);
            addFormulaRow("Kisz√°ll√°si d√≠j - Szerel≈ë", `=${travelTime}*2*${sO}*${sF}`, "√≥ra", `=${rateCellMap.kiszallasi_dij_szerelo}`, "0");
            addFormulaRow("Kisz√°ll√°si d√≠j - M√©rn√∂k", `=${travelTime}*2*${mO}*${mF}`, "√≥ra", `=${rateCellMap.kiszallasi_dij_mernok}`, "0");
            addFormulaRow("J√°rm≈± km d√≠j", `=${tav}*2*(${sO}*${sJ}+${mO}*${mJ})`, "km", `=${rateCellMap.km_dij}`, `=${rateCellMap.km_dij}`);
            addFormulaRow("Sz√°ll√°s k√∂lts√©g", `=${sSz}*${sF}+${mSz}*${mF}`, "√©j", `=${rateCellMap.szallas_dij}*(1+${rateCellMap.szallas_szorzo}/100)`, `=${rateCellMap.szallas_dij}`);
            addFormulaRow("Emel≈ëg√©p napid√≠j", `=${eDb}*${eN}`, "nap", `=${rateCellMap.emelogep_napidij}*(1+${rateCellMap.emelogep_szorzo}/100)`, `=${rateCellMap.emelogep_napidij}`);
            addFormulaRow("Emel≈ëg√©p sz√°ll√≠t√°s", `=${eSz}*2`, "alk", `=${rateCellMap.emelogep_szallitas_dij}*(1+${rateCellMap.emelogep_szorzo}/100)`, `=${rateCellMap.emelogep_szallitas_dij}`);

            // Egy√©b k√∂lts√©gek (statikus √©rt√©kekkel)
            state.otherCosts.forEach(c => {
                if (c.isSaved && c.description) {
                    const cost = c.amount;
                    const sell = c.isCostItem ? cost * (1 + (c.multiplier / 100)) : cost;
                    XLSX.utils.sheet_add_aoa(ws_calc, [[c.description, c.quantity, c.unit, sell, c.isCostItem ? cost : 0, c.quantity * sell]], { origin: calcRowIdx });
                    calcRowIdx++;
                }
            });
            const lastCalcRow = calcRowIdx - 1;

            // √ñsszes√≠t√©s
            calcRowIdx++;
            const offerCol = "F", costCol = "E";
            const totalFormula = `SUM(${offerCol}${firstCalcRow + 1}:${offerCol}${lastCalcRow + 1})`;
            addCalcRow(['', '', '', '', '√ñsszesen:', {t:'n', f: totalFormula, z: HUF_FORMAT}]);
            const totalCell = `F${calcRowIdx}`;
            
            const discountPercent = parseFloat(unformatCurrencyValue(inputs['discount-input'])) || 0;
            if (discountPercent > 0) {
                addCalcRow(['', '', '', '', `Kedvezm√©ny (${discountPercent}%):`, {t:'n', f: `-${totalCell}*${discountPercent/100}`, z: HUF_FORMAT}]);
                const discountCell = `F${calcRowIdx}`;
                addCalcRow(['', '', '', '', 'Kedvezm√©nyes V√©g√∂sszeg:', {t:'n', f: `=${totalCell}+${discountCell}`, z: HUF_FORMAT}]);
            }
            if (showCost) {
                const costTotalFormula = `SUM(${costCol}${firstCalcRow + 1}:${costCol}${lastCalcRow + 1})`;
                addCalcRow(['', '', '', '', '√ñnk√∂lts√©g √ñsszesen:', {t:'n', f: costTotalFormula, z: HUF_FORMAT}]);
            }
            
            ws_calc["!cols"] = [{ wch: 40 }, { wch: 15 }, { wch: 10 }, { wch: 20 }, { wch: 20 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws_calc, "Kalkul√°ci√≥");
            
            const offerNum = inputs.offer_number || "ajanlat";
            const dateStr = inputs.calculation_date || new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `${offerNum}-Kalkulacio-Dinamikus-${dateStr}.xlsx`);
        }

        D('password-form').onsubmit = (e) => {
            e.preventDefault(); 
            if (D('password-input').value === ADMIN_PASSWORD) {
                D('landing-page').style.display = 'none'; 
                D('app-container').style.display = 'block'; 
                initApp();
            } else { alert("Hib√°s jelsz√≥!"); }
        };
    </script>
</body>
</html>