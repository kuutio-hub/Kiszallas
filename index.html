<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kisz√°ll√°si Kalkul√°tor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        @font-face {
            font-family: 'DejaVuSans';
            src: url('https://cdn.jsdelivr.net/gh/dejavu-fonts/dejavu-fonts-ttf/ttf/DejaVuSans.ttf') format('truetype');
        }
        :root {
            --seahawks-navy: #002244; --seahawks-green: #69BE28; --seahawks-gray: #A5ACAF;
            --bg-primary: #1a202c; --bg-secondary: #2d3748; --bg-tertiary: #4a5568;
            --text-primary: #edf2f7; --text-secondary: #a0aec0; --text-on-accent: #000000;
            --border-color: #4a5568;
            --accent-primary: var(--seahawks-green);
            --accent-secondary: color-mix(in srgb, var(--seahawks-green) 85%, black);
            --danger-primary: #9B2C2C;
            --warning-text: #fca5a5;
            --success-primary: var(--seahawks-green);
            --font-family: 'Segoe UI', system-ui, sans-serif;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --border-radius: 0.5rem;
            --glow-color: color-mix(in srgb, var(--seahawks-green) 80%, transparent);
            --glow-color-darker: color-mix(in srgb, var(--seahawks-green) 70%, black 40%);
        }

        .light-mode {
            --bg-primary: #f8f9fa; --bg-secondary: #ffffff; --bg-tertiary: #e9ecef;
            --text-primary: #212529; --text-secondary: #6c757d; --text-on-accent: #ffffff;
            --border-color: #dee2e6; --accent-primary: #0d6efd; --accent-secondary: #0b5ed7;
            --danger-primary: #dc3545; --warning-text: #dc3545; --success-primary: #198754;
            --glow-color: color-mix(in srgb, var(--accent-primary) 50%, transparent);
            --glow-color-darker: color-mix(in srgb, var(--accent-primary) 60%, black 20%);
        }

        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number], input[type=text].currency-input { -moz-appearance: textfield; text-align: right; }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); font-size: 14px; transition: background-color 0.3s, color 0.3s; overflow-x: hidden; }
        
        #landing-page { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; text-align: center; padding: 1rem; }
        #landing-content { background-color: var(--bg-secondary); padding: 2.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); width: 100%; max-width: 400px; border: 1px solid var(--border-color); }
        #landing-content h1 { margin-bottom: 2rem; color: var(--accent-primary); font-size: 1.8rem; }
        #password-input { width: 100%; padding: 0.8rem; margin-bottom: 1.5rem; border-radius: 0.3rem; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); text-align: center; font-size: 1rem; }
        
        #app-container { display: none; }
        .container { max-width: 1800px; margin: 1rem auto; padding: 1rem; width: 100%; }

        .header { display: flex; flex-wrap: wrap; gap: 0.8rem; align-items: stretch; margin-bottom: 1.5rem; }
        .header-item { display: flex; align-items: center; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow); flex-grow: 1; min-width: 180px; }
        .header-item-title { padding: 0.5rem 0.8rem; font-weight: bold; color: var(--text-primary); background-color: var(--bg-tertiary); white-space: nowrap; font-size: 0.85rem; }
        .header input, .header select { padding: 0.5rem; border: none; background-color: transparent; color: var(--text-primary); font-size: 0.9rem; width: 100%; }
        .header input:focus, .header select:focus { outline: none; box-shadow: 0 0 0 3px var(--glow-color); }
        
        .input-with-button { display: flex; align-items: center; flex-grow: 1; }
        .input-with-button button { padding: 0 0.6rem; border: none; background-color: var(--bg-tertiary); color: var(--text-primary); cursor: pointer; transition: background-color 0.2s; height: 100%; }
        .input-with-button button:hover { background-color: var(--accent-primary); color: var(--text-on-accent); }
        
        .seahawks-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding-right: 2rem !important; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2369BE28'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; }
        .header-action-btn { cursor: pointer; background: var(--bg-secondary); border-left: 1px solid var(--border-color); padding: 0.5rem; display: flex; align-items: center; justify-content: center; }
        
        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: var(--border-radius); font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out; box-shadow: var(--shadow); background-color: var(--bg-tertiary); color: var(--text-primary); display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 0 0 3px var(--glow-color-darker); }
        .btn-danger { background-color: var(--danger-primary); color: #ffffff; }
        .btn-success { background-color: var(--success-primary); color: var(--text-on-accent); }
        .btn-icon { font-size: 1.2em; }
        
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        
        .card { background-color: var(--bg-secondary); border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        details.card { padding: 0; overflow: hidden; margin-bottom: 1rem; }
        details.card summary { padding: 1rem; cursor: pointer; font-size: 1.05rem; font-weight: 600; position: relative; display: flex; justify-content: space-between; align-items: center; list-style: none; }
        details.card summary::-webkit-details-marker { display: none; }
        details.card summary::after { content: ''; display: inline-block; width: 20px; height: 20px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23a0aec0'%3E%3Cpath d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z'/%3E%3C/svg%3E"); transition: transform 0.2s; }
        details[open].card > summary::after { transform: rotate(180deg); }
        details.card .card-content { padding: 1rem; }
        
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--border-color); text-align: left; }
        thead { background-color: var(--seahawks-navy); color: var(--text-primary); }
        .discount-row td { color: var(--warning-text); }
        .success-row td { color: var(--success-primary); font-weight: bold; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .form-group label { margin-bottom: 0.4rem; font-size: 0.8rem; color: var(--text-secondary); display: block; }
        .form-group input, .form-group select { width: 100%; padding: 0.5rem; border-radius: 0.3rem; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); }
        .travel-unit-toggle { cursor: pointer; text-decoration: underline; color: var(--accent-primary); }
        
        .card-controls { display: flex; justify-content: flex-end; align-items: center; gap: 1rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        
        .action-bar { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; margin-top: 1.5rem; padding: 1rem; background-color: var(--bg-secondary); border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .print-controls-group { display: flex; flex-direction: column; gap: 0.8rem; border: 1px solid var(--border-color); padding: 0.8rem; border-radius: var(--border-radius); }
        .print-controls-group #print-btn { width: 100%; }
        .print-group { display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .radio-pill { cursor: pointer; }
        .radio-pill input { display: none; }
        .radio-pill span { padding: 0.35rem 0.7rem; border-radius: 0.3rem; font-size: 0.75rem; display: inline-block; color: var(--text-secondary); transition: 0.2s; }
        .radio-pill input:checked + span { background-color: var(--accent-primary); color: var(--text-on-accent); font-weight: bold; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        #print-preview-modal { z-index: 2001; }
        .modal-content { background-color: var(--bg-secondary); margin: 5vh auto; padding: 1.5rem; width: 90%; max-width: 900px; border-radius: var(--border-radius); border: 1px solid var(--border-color); display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-body { overflow-y: auto; flex-grow: 1; }
        .modal-footer { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .modal-close-btn { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; }
        
        #print-preview-iframe { width: 100%; height: 60vh; border: 1px solid var(--border-color); background-color: #fff; }

        .mobile-results-btn { display: none; }

        #rate-editor-fields .rate-group-title {
            grid-column: 1 / -1; margin-top: 1.5rem; margin-bottom: 0.5rem; font-size: 1rem;
            color: var(--accent-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;
        }
        #rate-editor-fields .rate-group-title:first-of-type { margin-top: 0; }
        
        .other-cost-item { display: flex; flex-direction: column; gap: 0.8rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .other-cost-row-1, .other-cost-row-2 { display: flex; flex-wrap: wrap; gap: 0.8rem; align-items: flex-end; }
        .other-cost-row-1 .description { flex: 1 1 auto; }
        .other-cost-row-1 .delete-btn { flex-shrink: 0; }
        .other-cost-row-2 .quantity, .other-cost-row-2 .unit, .other-cost-row-2 .amount, .other-cost-row-2 .multiplier { flex: 1 1 90px; }
        .other-cost-row-2 .is-cost-item-group { display: flex; align-items: center; gap: 0.5rem; flex: 0 1 auto; white-space: nowrap; padding-bottom: 0.5rem; }
        .other-cost-row-2 .multiplier { transition: visibility 0.2s, opacity 0.2s; }
        .other-cost-row-2 .multiplier.hidden { visibility: hidden; opacity: 0; }

        #calculation-summary-header-content { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; padding: 1rem; }
        #calculation-summary-header-content .summary-title { flex-basis: 100%; text-align: center; font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: var(--accent-primary); }
        #calculation-summary-header-content .summary-col { flex: 1; min-width: 200px; padding: 0 1rem; }
        #calculation-summary-header-content .summary-col p { margin-bottom: 0.3rem; }
        #calculation-summary-header-content .summary-col strong { color: var(--text-secondary); margin-right: 0.5em; }
        
        @media (min-width: 1024px) {
            .main-grid { grid-template-columns: 1fr 1.5fr; }
        }

        @media (max-width: 1023px) {
            .container { padding: 0.5rem; }
            .header-item { min-width: calc(50% - 0.4rem); }
            .action-bar { flex-direction: column; align-items: stretch; }
            .action-bar .btn { flex-grow: 1; width: auto; }
            .action-bar .print-controls-group { width: 100%; }
            .calculation-table { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 3000; background: var(--bg-primary); overflow-y: auto; padding: 1rem; flex-direction: column; }
            .calculation-table.mobile-visible { display: flex; }
            .calculation-table .table-wrapper { flex-grow: 1; }
            .close-mobile-results { display: block; margin-top: 1rem; }
            .mobile-results-btn { display: flex; position: fixed; bottom: 1rem; right: 1rem; z-index: 2500; width: 56px; height: 56px; border-radius: 50%; align-items: center; justify-content: center; font-size: 1.5rem; background-color: var(--accent-primary); color: var(--text-on-accent); box-shadow: 0 4px 12px rgba(0,0,0,0.3); border: none; cursor: pointer; }
            .copyright-version::before { content: '\\A'; white-space: pre; }
        }
        
        footer { text-align: center; padding: 2rem 1rem; color: var(--text-secondary); font-size: 0.8rem; margin-top: 2rem; border-top: 1px solid var(--border-color); }
    </style>
</head>
<body>

    <div id="landing-page">
        <div id="landing-content">
            <h1>K√∂lts√©gkalkul√°tor</h1>
            <form id="password-form">
                <input type="password" id="password-input" placeholder="Jelsz√≥" required autocomplete="current-password">
                <button type="submit" class="btn btn-success" style="width: 100%;">Bel√©p√©s</button>
            </form>
        </div>
        <footer id="landing-footer" style="border:none; padding-top: 2rem;"></footer>
    </div>

    <div id="app-container">
        <div class="container">
            <header class="header">
                 <div class="header-item">
                    <span class="header-item-title">√Årlista</span>
                    <select id="rate-package-select" class="seahawks-select"></select>
                </div>
                <div class="header-item">
                    <span class="header-item-title">P√©nznem</span>
                    <select id="currency-select" class="seahawks-select">
                        <option value="HUF">HUF</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
                <div class="header-item">
                    <span class="header-item-title">√Årfolyam</span>
                    <div class="input-with-button">
                        <input type="number" id="exchange-rate-manual" step="0.01">
                        <button id="exchange-rate-apply-btn" title="Alkalmaz">‚úì</button>
                    </div>
                </div>
                <div class="header-item">
                    <span class="header-item-title">Kedvezm√©ny (%)</span>
                    <div class="input-with-button">
                        <input type="number" id="discount-input" placeholder="0" min="0" max="100">
                        <button id="discount-apply-btn" title="Alkalmaz">‚úì</button>
                    </div>
                </div>
                <div class="header-item" style="border:none; box-shadow:none; background:transparent; flex-grow:0; display:flex; gap: 0.5rem; min-width: auto;">
                    <button id="reset-btn" class="btn" title="Mindent t√∂r√∂l">Vissza√°ll√≠t√°s</button>
                    <div id="theme-switcher" class="header-action-btn" title="T√©ma v√°lt√°s" style="border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 0.5rem;">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px;"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06z"/></svg>
                    </div>
                </div>
            </header>

            <main class="main-grid">
                <div class="inputs-container">
                     <details class="card" open>
                        <summary>Alapadatok</summary>
                        <div class="card-content">
                            <div class="form-grid">
                                <div class="form-group"><label for="offer_number">Aj√°nlatsz√°m</label><input type="text" id="offer_number"></div>
                                <div class="form-group"><label for="project_number">Projektsz√°m</label><input type="text" id="project_number" placeholder="Opcion√°lis"></div>
                                <div class="form-group"><label for="project_name">Projekt neve</label><input type="text" id="project_name" placeholder="Opcion√°lis"></div>
                                <div class="form-group"><label for="customer">Megrendel≈ë</label><input type="text" id="customer"></div>
                                <div class="form-group"><label for="calculation_date">Kalkul√°ci√≥ d√°tuma</label><input type="date" id="calculation_date"></div>
                                <div class="form-group"><label for="creator_name">K√©sz√≠t≈ë</label><input type="text" id="creator_name" placeholder="Opcion√°lis"></div>
                                <div class="form-group" style="grid-column: 1 / -1;"><label for="feladat">Feladat le√≠r√°sa</label><input type="text" id="feladat" style="max-width: none;"></div>
                            </div>
                            <div class="card-controls"><button class="btn card-save-btn btn-success">Ment√©s √©s bez√°r√°s</button></div>
                        </div>
                    </details>
                    
                    <details class="card"><summary>Utaz√°s</summary><div class="card-content"><div class="form-grid" id="utazas-inputs"></div><div class="card-controls"><button class="btn card-save-btn btn-success">Ment√©s √©s bez√°r√°s</button></div></div></details>
                    <details class="card"><summary>Szerel≈ëk</summary><div class="card-content"><div class="form-grid" id="szerelo-inputs"></div><div class="card-controls"><button class="btn card-save-btn btn-success">Ment√©s √©s bez√°r√°s</button></div></div></details>
                    <details class="card"><summary>M√©rn√∂k√∂k</summary><div class="card-content"><div class="form-grid" id="mernok-inputs"></div><div class="card-controls"><button class="btn card-save-btn btn-success">Ment√©s √©s bez√°r√°s</button></div></div></details>
                    <details class="card"><summary>Eszk√∂z√∂k</summary><div class="card-content"><div class="form-grid" id="emelogep-inputs"></div><div class="card-controls"><button class="btn card-save-btn btn-success">Ment√©s √©s bez√°r√°s</button></div></div></details>

                    <details class="card">
                        <summary>Egy√©b k√∂lts√©gek</summary>
                        <div class="card-content">
                            <div id="other-costs-list"></div>
                            <div class="item-list-controls" style="margin-top: 1rem; padding-bottom: 1rem;">
                                <button id="add-other-cost-btn" class="btn">+ √öj t√©tel</button>
                            </div>
                            <div class="card-controls"><button class="btn card-save-btn btn-success">Ment√©s √©s bez√°r√°s</button></div>
                        </div>
                    </details>
                     
                     <div class="action-bar">
                        <button id="manage-rates-btn" class="btn">
                            <span role="img" aria-hidden="true" class="btn-icon">‚öôÔ∏è</span><span class="btn-text">√Årlist√°k</span>
                        </button>
                        <div class="print-controls-group">
                            <div class="print-group">
                                <label class="radio-pill"><input type="radio" name="print-detail" value="simple" checked><span>Egyszer≈±</span></label>
                                <label class="radio-pill"><input type="radio" name="print-detail" value="detailed"><span>R√©szletes</span></label>
                                <label class="radio-pill"><input type="radio" name="print-detail" value="internal"><span>Teljes</span></label>
                            </div>
                            <button id="print-btn" class="btn btn-success">
                                <span role="img" aria-hidden="true" class="btn-icon">üñ®Ô∏è</span><span class="btn-text">Nyomtat√°s</span>
                            </button>
                        </div>
                     </div>
                </div>
                
                <div class="card calculation-table" id="results-panel">
                    <button class="btn close-mobile-results btn-danger">Bez√°r√°s</button>
                    <details class="card" id="calculation-summary-header">
                        <summary>Projekt Adatok</summary>
                        <div id="calculation-summary-header-content"></div>
                    </details>
                    <div class="table-wrapper">
                        <table>
                            <thead id="breakdown-head"></thead>
                            <tbody id="breakdown-body"></tbody>
                            <tfoot id="breakdown-foot"></tfoot>
                        </table>
                    </div>
                </div>
            </main>
            <button class="mobile-results-btn" id="mobile-results-btn" title="Eredm√©nyek">üìä</button>
            <footer id="copyright-footer"></footer>
        </div>
    </div>
    
    <div id="print-preview-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nyomtat√°si el≈ën√©zet</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <iframe id="print-preview-iframe"></iframe>
            </div>
            <div class="modal-footer" style="justify-content: flex-end;">
                <button id="execute-print-btn" class="btn btn-success">Nyomtat√°s ind√≠t√°sa</button>
            </div>
        </div>
    </div>

    <div id="rate-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>√Årlist√°k Kezel√©se (ideiglenes m√≥dos√≠t√°s)</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid" style="grid-template-columns: 1fr; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label for="rate-package-selector-modal">V√°lasszon √°rlist√°t</label>
                        <select id="rate-package-selector-modal" class="seahawks-select"></select>
                    </div>
                </div>
                <div id="rate-editor-fields" class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));"></div>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <button id="rate-print-btn" class="btn">Nyomtat</button>
                <button class="btn modal-close-btn" style="font-size: 0.9rem;">Bez√°r√°s</button>
            </div>
        </div>
    </div>

    <script type="module">
        const ADMIN_PASSWORD = 'Kalkulator_2026';
        const APP_VERSION = "v3.2.19";

        const RATE_EDITOR_GROUPS = [
            {
                title: 'Fix D√≠jt√©telek (nem m√≥dos√≠that√≥)',
                type: 'fixed',
                keys: ['szerelo_hetkoznap_oradij', 'szerelo_hetvege_oradij', 'szerelesvezeto_hetkoznap_oradij', 'szerelesvezeto_hetvege_oradij', 'mernok_hetkoznap_oradij', 'mernok_hetvege_oradij', 'kiszallasi_dij_szerelo', 'kiszallasi_dij_mernok', 'kikuldeles_dij_szerelo', 'kikuldeles_dij_mernok']
            },
            {
                title: 'M√≥dos√≠that√≥ D√≠jt√©telek',
                type: 'overridable',
                keys: ['km_dij', 'szallas_dij', 'szallas_szorzo', 'emelogep_napidij', 'emelogep_szallitas_dij', 'emelogep_szorzo']
            }
        ];
        
        const footerHTML = `&copy; ${new Date().getFullYear()} K√∂lts√©gkalkul√°tor <span class="copyright-version">| Verzi√≥: ${APP_VERSION}</span>`;
        document.getElementById('landing-footer').innerHTML = footerHTML;
        document.getElementById('copyright-footer').innerHTML = footerHTML;

        let state = {
            rates: [], otherCosts: [], exchangeRates: {}, activeRatePackage: null,
            calculationResults: null, activeCurrency: 'HUF', config: {},
            travelTimeUnit: '√≥ra'
        };

        const D = (id) => document.getElementById(id);
        const formatCustomCurrency = (val, currencySymbol = 'Ft') => {
            const num = parseFloat(val) || 0;
            if (currencySymbol === '‚Ç¨') {
                const fixedNumStr = num.toFixed(2);
                let [integerPart, decimalPart] = fixedNumStr.split('.');
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                return `${integerPart},${decimalPart}.- ‚Ç¨`;
            }
            const str = Math.round(num).toString();
            return `${str.replace(/\B(?=(\d{3})+(?!\d))/g, ".")}.- Ft`;
        };
        
        const convertPrice = (huf, curr) => curr === 'EUR' ? huf / (parseFloat(D('exchange-rate-manual').value) || 1) : huf;
        
        async function fetchExchangeRates() {
            const cached = localStorage.getItem('exchangeRates');
            const now = new Date();
            if (cached) {
                const { timestamp, data } = JSON.parse(cached);
                if (now.getTime() - timestamp < 4 * 60 * 60 * 1000) {
                    state.exchangeRates = data; return;
                }
            }
            try {
                const end = now.toISOString().split('T')[0];
                const start = new Date(new Date().setDate(now.getDate() - 90)).toISOString().split('T')[0];
                const response = await fetch(`https://api.frankfurter.app/${start}..${end}?from=EUR&to=HUF`);
                if (!response.ok) throw new Error('API hiba');
                const data = await response.json();
                state.exchangeRates = data;
                localStorage.setItem('exchangeRates', JSON.stringify({ timestamp: new Date().getTime(), data }));
            } catch (error) {
                console.error("√Årfolyam lek√©rdez√©s sikertelen:", error);
                alert("Az √°rfolyamadatok lek√©rdez√©se nem siker√ºlt. K√©zi be√°ll√≠t√°s sz√ºks√©ges.");
            }
        }

        function setLatestExchangeRate() {
            if (state.exchangeRates && state.exchangeRates.rates) {
                const dates = Object.keys(state.exchangeRates.rates).sort();
                const latestDate = dates[dates.length - 1];
                if (latestDate && state.exchangeRates.rates[latestDate].HUF) {
                    D('exchange-rate-manual').value = state.exchangeRates.rates[latestDate].HUF.toFixed(2);
                }
            }
        }
        
        async function initApp() {
            try {
                D('calculation-summary-header').open = false;
                D('calculation_date').value = new Date().toISOString().split('T')[0];
                await fetchExchangeRates();
                setLatestExchangeRate();

                const [ratesRes, labelsRes, inputsRes] = await Promise.all([
                    fetch('rates.json'), fetch('rate_key_labels.json'), fetch('input_config.json')
                ]);
                state.config = { RATE_KEY_LABELS: await labelsRes.json(), INPUT_CONFIG: await inputsRes.json() };
                state.rates = await ratesRes.json();

                renderInputs(); 
                updateRateSelectors();
                const initialPackageId = D('rate-package-select').value;
                state.activeRatePackage = state.rates.find(r => r.id === initialPackageId) || state.rates[0];
                
                setupOtherCostsList();
                calculateAndDisplay();

                // --- EVENT LISTENERS ---
                
                D('app-container').addEventListener('input', (e) => {
                    if (e.target.closest('#other-costs-list')) handleOtherCostInput(e);
                    else if (e.target.name === 'print-detail') calculateAndDisplay();
                    else calculateAndDisplay();
                });

                D('app-container').addEventListener('click', (e) => {
                    if (e.target.closest('.other-cost-delete-btn')) {
                        const index = parseInt(e.target.closest('.other-cost-delete-btn').dataset.index, 10);
                        state.otherCosts.splice(index, 1);
                        setupOtherCostsList(); calculateAndDisplay();
                    }
                    if (e.target.closest('.card-save-btn')) { e.target.closest('details').open = false; }
                    if (e.target.closest('.travel-unit-toggle')) { handleTravelUnitToggle(); }
                });

                D('add-other-cost-btn').onclick = () => {
                    state.otherCosts.push({ description: '', amount: 0, quantity: 1, unit: 'db', isCostItem: false, multiplier: 30 });
                    setupOtherCostsList();
                };

                D('currency-select').onchange = (e) => { state.activeCurrency = e.target.value; calculateAndDisplay(); };
                D('reset-btn').onclick = () => { if(confirm("Minden beviteli mez≈ët t√∂r√∂l? A m√≥dos√≠tott √°rak is alaphelyzetbe √°llnak.")) location.reload(); };
                D('theme-switcher').onclick = () => document.body.classList.toggle('light-mode');
                
                D('manage-rates-btn').onclick = openRateManager;
                D('print-btn').onclick = () => handlePrint();

                const mobileResultsBtn = D('mobile-results-btn');
                const resultsPanel = D('results-panel');
                const closeMobileResultsBtn = resultsPanel.querySelector('.close-mobile-results');
                if (mobileResultsBtn) mobileResultsBtn.onclick = () => resultsPanel.classList.add('mobile-visible');
                if (closeMobileResultsBtn) closeMobileResultsBtn.onclick = () => resultsPanel.classList.remove('mobile-visible');

                document.querySelectorAll('.modal-close-btn').forEach(btn => btn.onclick = () => btn.closest('.modal').style.display = 'none');
                D('execute-print-btn').onclick = () => D('print-preview-iframe').contentWindow.print();
                
                const syncRatePackages = (newPackageId) => {
                    state.activeRatePackage = state.rates.find(r => r.id === newPackageId);
                    D('rate-package-select').value = newPackageId;
                    D('rate-package-selector-modal').value = newPackageId;
                    populateRateForm(newPackageId);
                    calculateAndDisplay();
                };

                D('rate-package-select').onchange = (e) => syncRatePackages(e.target.value);
                D('rate-package-selector-modal').onchange = (e) => syncRatePackages(e.target.value);
                D('rate-print-btn').onclick = handlePrintRateList;

                D('rate-editor-fields').addEventListener('input', (e) => {
                    const input = e.target;
                    const key = input.dataset.rateKey;
                    const type = input.dataset.rateType;
                    const value = parseFloat(input.value) || 0;
                    const activePackageId = D('rate-package-selector-modal').value;
                    const packageToEdit = state.rates.find(r => r.id === activePackageId);

                    if (key && type && packageToEdit && packageToEdit.rates[type]) {
                        packageToEdit.rates[type][key] = value;
                        calculateAndDisplay();
                    }
                });

            } catch (error) {
                console.error("Alkalmaz√°s inicializ√°l√°si hiba:", error);
                alert("Hiba t√∂rt√©nt az alkalmaz√°s bet√∂lt√©se k√∂zben. K√©rj√ºk, friss√≠tse az oldalt.");
            }
        }
        
        function renderInputs() {
            Object.entries(state.config.INPUT_CONFIG).forEach(([group, configs]) => {
                const container = D(`${group}-inputs`);
                if (container) {
                    container.innerHTML = '';
                    configs.forEach(config => {
                        const groupEl = document.createElement('div');
                        groupEl.className = 'form-group';
                        groupEl.innerHTML = `<label for="${config.id}">${config.label}</label>`;
                        let inputEl;
                        if (config.type === 'select') {
                            inputEl = document.createElement('select');
                            config.options.forEach(opt => inputEl.add(new Option(opt.text, opt.value)));
                        } else {
                            inputEl = document.createElement('input');
                            inputEl.type = config.type === 'text' ? 'text' : 'number';
                        }
                        inputEl.id = config.id;
                        groupEl.appendChild(inputEl);
                        container.appendChild(groupEl);
                    });
                }
            });
        }
        
        function getInputs(){
            const inputs = {};
            document.querySelectorAll('#app-container input, #app-container select').forEach(el => {
                if (el.id) {
                    if (el.type === 'number' || el.type === 'checkbox') inputs[el.id] = (el.type === 'checkbox') ? el.checked : (parseFloat(el.value) || 0);
                    else inputs[el.id] = el.value;
                }
            });
            return inputs;
        }

        function calculateCosts() {
            const inputs = getInputs(); 
            const pkg = state.activeRatePackage;
            if (!pkg || !pkg.rates) return { totalHuf: 0, totalCostHuf: 0, breakdown: [], hasCostItems: false };
            const rates = { ...pkg.rates.fixed, ...pkg.rates.overridable };

            let breakdown = [], totalSell = 0, totalCost = 0, hasCostItems = false;
            
            const addItem = (label, quantity, unit, sellPrice, costPrice, isCostItem) => {
                if (quantity > 0 && sellPrice > 0) {
                    const totalSellPrice = quantity * sellPrice;
                    const totalCostPrice = quantity * costPrice;
                    breakdown.push({ label, quantity, unit, unitPriceHuf: sellPrice, totalHuf: totalSellPrice, costPriceHuf: costPrice, totalCostHuf: totalCostPrice, isCostItem });
                    totalSell += totalSellPrice;
                    if (isCostItem) {
                        totalCost += totalCostPrice;
                        hasCostItems = true;
                    }
                }
            };

            const sN = inputs.szerelo_munkanap || 0, sF = inputs.szerelo_fo || 0, sH = inputs.szerelo_munkaora || 0, sW = inputs.szerelo_hetvegi_nap || 0;
            const mN = inputs.mernok_munkanap || 0, mF = inputs.mernok_fo || 0, mH = inputs.mernok_munkaora || 0, mW = inputs.mernok_hetvegi_nap || 0;
            const sWd = sN - sW; const mWd = mN - mW;

            if (mF > 0 && mN > 0) {
                addItem('M√©rn√∂k (h√©tk√∂znap)', mF * mWd * mH, '√≥ra', rates.mernok_hetkoznap_oradij, rates.mernok_hetkoznap_oradij, false);
                addItem('M√©rn√∂k (h√©tv√©ge)', mF * mW * mH, '√≥ra', rates.mernok_hetvege_oradij, rates.mernok_hetvege_oradij, false);
            }
            if (sF > 0 && sN > 0) {
                const foreman_needed_wd = Math.max(0, sWd - mWd);
                const foreman_needed_we = Math.max(0, sW - mW);
                addItem('Szerel√©svezet≈ë (h√©tk√∂znap)', foreman_needed_wd * sH, '√≥ra', rates.szerelesvezeto_hetkoznap_oradij, rates.szerelesvezeto_hetkoznap_oradij, false);
                addItem('Szerel√©svezet≈ë (h√©tv√©ge)', foreman_needed_we * sH, '√≥ra', rates.szerelesvezeto_hetvege_oradij, rates.szerelesvezeto_hetvege_oradij, false);
                addItem('Szerel≈ë (h√©tk√∂znap)', (sF * sWd * sH) - (foreman_needed_wd * sH), '√≥ra', rates.szerelo_hetkoznap_oradij, rates.szerelo_hetkoznap_oradij, false);
                addItem('Szerel≈ë (h√©tv√©ge)', (sF * sW * sH) - (foreman_needed_we * sH), '√≥ra', rates.szerelo_hetvege_oradij, rates.szerelo_hetvege_oradij, false);
            }
            if(inputs.location_type === 'kulfold'){
                addItem('Kik√ºldet√©s - Szerel≈ë', sF * sN, 'nap', rates.kikuldeles_dij_szerelo, rates.kikuldeles_dij_szerelo, true);
                addItem('Kik√ºldet√©s - M√©rn√∂k', mF * mN, 'nap', rates.kikuldeles_dij_mernok, rates.kikuldeles_dij_mernok, true);
            }
            
            let travelTime = inputs.utazas_ido_ora || 0;
            if (state.travelTimeUnit === 'perc') travelTime /= 60;
            
            addItem('Kisz√°ll√°si d√≠j - Szerel≈ë', travelTime * 2 * (inputs.utazas_odautak_szama_szerelo || 0) * sF, '√≥ra', rates.kiszallasi_dij_szerelo, rates.kiszallasi_dij_szerelo, false);
            addItem('Kisz√°ll√°si d√≠j - M√©rn√∂k', travelTime * 2 * (inputs.utazas_odautak_szama_mernok || 0) * mF, '√≥ra', rates.kiszallasi_dij_mernok, rates.kiszallasi_dij_mernok, false);
            addItem('J√°rm≈± km d√≠j', (inputs.utazas_tavolsag_km || 0) * 2 * ((inputs.utazas_odautak_szama_szerelo || 0) * (inputs.utazas_jarmuvek_szama_szerelo || 0) + (inputs.utazas_odautak_szama_mernok || 0) * (inputs.utazas_jarmuvek_szama_mernok || 0)), 'km', rates.km_dij, rates.km_dij, true);
            
            addItem('Sz√°ll√°s k√∂lts√©g', (inputs.szerelo_szallas_ejszaka || 0) * sF + (inputs.mernok_szallas_ejszaka || 0) * mF, '√©j', rates.szallas_dij * (1 + rates.szallas_szorzo / 100), rates.szallas_dij, true);

            addItem('Emel≈ëg√©p napid√≠j', (inputs.emelogep_db || 0) * (inputs.emelogep_napok || 0), 'nap', rates.emelogep_napidij * (1 + rates.emelogep_szorzo / 100), rates.emelogep_napidij, true);
            addItem('Emel≈ëg√©p sz√°ll√≠t√°s', (inputs.emelogep_szallitasok || 0) * 2, 'alk', rates.emelogep_szallitas_dij * (1 + rates.emelogep_szorzo / 100), rates.emelogep_szallitas_dij, true);
            
            state.otherCosts.forEach(c => {
                if (c.amount > 0 && c.description) {
                    const cost = c.amount;
                    const sell = c.isCostItem ? cost * (1 + (c.multiplier / 100)) : cost;
                    addItem(c.description, c.quantity || 1, c.unit || 'db', sell, cost, c.isCostItem);
                }
            });

            return { totalHuf: totalSell, totalCostHuf: totalCost, breakdown, hasCostItems };
        }

        function calculateAndDisplay(){
            state.calculationResults = calculateCosts();
            const inputs = getInputs();
            const { breakdown, totalHuf, totalCostHuf, hasCostItems } = state.calculationResults;
            const tbody = D('breakdown-body'), thead = D('breakdown-head'), tfoot = D('breakdown-foot');
            const currency = state.activeCurrency, symbol = currency === 'EUR' ? '‚Ç¨' : 'Ft';
            const discount = inputs['discount-input'] || 0;
            const detailLevel = document.querySelector('input[name="print-detail"]:checked').value;
            
            D('calculation-summary-header-content').innerHTML = `
                <div class="summary-title">Kisz√°ll√°s kalkul√°ci√≥</div>
                <div class="summary-col">
                    <p><strong>Aj√°nlatsz√°m:</strong> ${inputs.offer_number || '-'}</p>
                    <p><strong>Projektsz√°m:</strong> ${inputs.project_number || '-'}</p>
                    <p><strong>D√°tum:</strong> ${new Date(inputs.calculation_date).toLocaleDateString('hu-HU')}</p>
                </div>
                <div class="summary-col">
                    <p><strong>Megrendel≈ë:</strong> ${inputs.customer || '-'}</p>
                    <p><strong>Projekt neve:</strong> ${inputs.project_name || '-'}</p>
                    <p><strong>K√©sz√≠t≈ë:</strong> ${inputs.creator_name || '-'}</p>
                </div>`;

            tbody.innerHTML = thead.innerHTML = tfoot.innerHTML = '';
            const showCost = hasCostItems && detailLevel === 'internal';

            let headerHtml = '';
            if (detailLevel === 'simple') {
                headerHtml = '<tr><th>K√∂lts√©gnem</th><th style="text-align:right;">√ñsszesen</th></tr>';
            } else {
                headerHtml = '<tr><th>K√∂lts√©gnem</th><th style="text-align:right;">Menny.</th><th>Egys.</th><th style="text-align:right;">Egys√©g√°r</th>';
                if (showCost) headerHtml += '<th style="text-align:right;">√ñnk√∂lts√©g</th>';
                headerHtml += '<th style="text-align:right;">√ñsszesen</th></tr>';
            }
            thead.innerHTML = headerHtml;
            
            breakdown.forEach(item => {
                const row = tbody.insertRow();
                let cells = '';
                if (detailLevel === 'simple') {
                    cells = `<td>${item.label}</td><td style="text-align:right;">${formatCustomCurrency(convertPrice(item.totalHuf, currency), symbol)}</td>`;
                } else {
                    cells = `<td>${item.label}</td><td style="text-align:right;">${item.quantity.toLocaleString('hu-HU')}</td><td style="text-align:center;">${item.unit}</td><td style="text-align:right;">${formatCustomCurrency(convertPrice(item.unitPriceHuf, currency), symbol)}</td>`;
                    if(showCost) {
                        cells += `<td style="text-align:right;">${item.isCostItem ? formatCustomCurrency(convertPrice(item.totalCostHuf, currency), symbol) : '-'}</td>`;
                    }
                    cells += `<td style="text-align:right;">${formatCustomCurrency(convertPrice(item.totalHuf, currency), symbol)}</td>`;
                }
                row.innerHTML = cells;
            });

            const totalSellFinal = convertPrice(totalHuf, currency);
            const colspanForLabel = detailLevel === 'simple' ? 1 : (showCost ? 5 : 4);
            
            let footerHtml = ``;
            if (showCost) {
                const totalCostFinal = convertPrice(totalCostHuf, currency);
                footerHtml += `<tr><td colspan="${colspanForLabel}" style="text-align:right; font-weight:bold;">√ñnk√∂lts√©g √∂sszesen</td><td style="text-align:right; font-weight:bold;">${formatCustomCurrency(totalCostFinal, symbol)}</td></tr>`;
            }
            footerHtml += `<tr style="border-top: 2px solid var(--accent-primary);"><td colspan="${colspanForLabel}" style="text-align:right; font-weight:bold;">V√©g√∂sszeg (${currency})</td><td style="text-align:right; font-weight:bold;">${formatCustomCurrency(totalSellFinal, symbol)}</td></tr>`;
            
            if (discount > 0) {
                const discountedTotal = totalSellFinal * (1 - discount/100);
                footerHtml += `<tr class="discount-row"><td colspan="${colspanForLabel}" style="text-align:right;">Engedm√©ny (${discount}%)</td><td style="text-align:right;">- ${formatCustomCurrency(totalSellFinal - discountedTotal, symbol)}</td></tr>`;
                footerHtml += `<tr class="success-row"><td colspan="${colspanForLabel}" style="text-align:right;">Kedvezm√©nyes v√©g√∂sszeg</td><td style="text-align:right;">${formatCustomCurrency(discountedTotal, symbol)}</td></tr>`;
            }
            tfoot.innerHTML = footerHtml;
        }
        
        function openRateManager() { 
            D('rate-modal').style.display = 'block'; 
            D('rate-package-selector-modal').value = state.activeRatePackage.id;
            populateRateForm(state.activeRatePackage.id);
        }
        
        function updateRateSelectors(selectedId) {
            const mainSelector = D('rate-package-select');
            const modalSelector = D('rate-package-selector-modal');
            const currentVal = selectedId || mainSelector.value || (state.rates[0] ? state.rates[0].id : '');
            
            mainSelector.innerHTML = ''; 
            modalSelector.innerHTML = ''; 
            state.rates.forEach(p => {
                mainSelector.add(new Option(p.name, p.id));
                modalSelector.add(new Option(p.name, p.id));
            });
            
            if (state.rates.some(r => r.id === currentVal)) {
                mainSelector.value = currentVal;
                modalSelector.value = currentVal;
            } else if (mainSelector.options.length > 0) {
                mainSelector.value = mainSelector.options[0].value;
                modalSelector.value = modalSelector.options[0].value;
            }
        }

        function populateRateForm(packageId) {
            const pkg = state.rates.find(r => r.id === packageId); if (!pkg) return;
            const fieldsContainer = D('rate-editor-fields');
            fieldsContainer.innerHTML = '';
            
            RATE_EDITOR_GROUPS.forEach(group => {
                fieldsContainer.innerHTML += `<h3 class="rate-group-title">${group.title}</h3>`;
                const ratesSource = pkg.rates[group.type];
                group.keys.forEach(key => {
                    if (state.config.RATE_KEY_LABELS[key] && ratesSource.hasOwnProperty(key)) {
                        const label = state.config.RATE_KEY_LABELS[key];
                        const value = ratesSource[key] || 0;
                        const isDisabled = group.type === 'fixed';
                        fieldsContainer.innerHTML += `<div class="form-group"><label for="rate-edit-${key}">${label}</label><input type="number" id="rate-edit-${key}" data-rate-key="${key}" data-rate-type="${group.type}" value="${value}" ${isDisabled ? 'disabled' : ''}></div>`;
                    }
                });
            });
        }

        function handlePrint(isRateList = false, pkg) {
            const iframe = D('print-preview-iframe');
            let printableHtml;
            if (isRateList && pkg) {
                printableHtml = getRateListPrintableHtml(pkg);
            } else {
                const detailLevel = document.querySelector('input[name="print-detail"]:checked').value;
                printableHtml = getPrintableHtml(detailLevel, getInputs(), state.calculationResults);
            }
            iframe.srcdoc = printableHtml;
            iframe.onload = () => { iframe.contentWindow.scrollTo(0, 0); };
            D('print-preview-modal').style.display = 'block';
        }
        
        function handlePrintRateList() {
            const pkgId = D('rate-package-selector-modal').value;
            const pkg = state.rates.find(r => r.id === pkgId);
            if (pkg) handlePrint(true, pkg);
        }

        function getPrintableHtml(detailLevel, inputs, calcResults) {
            const { breakdown, totalHuf, totalCostHuf, hasCostItems } = calcResults;
            const currency = state.activeCurrency, symbol = currency === 'EUR' ? '‚Ç¨' : 'Ft';
            const discount = inputs['discount-input'] || 0;
            const totalSellFinal = convertPrice(totalHuf, currency);
            const discountedTotal = totalSellFinal * (1 - discount / 100);
            const showCost = hasCostItems && detailLevel === 'internal';

            const colspanForLabel = detailLevel === 'simple' ? 1 : (showCost ? 5 : 4);
            
            let tableRows = '';
            const headerCols = detailLevel === 'simple' ? '<th style="text-align:right;">√ñsszesen</th>' : `<th style="text-align:right;">Mennyis√©g</th><th style="text-align:right;">Egys√©g√°r</th>${showCost ? '<th style="text-align:right;">√ñnk√∂lts√©g</th>' : ''}<th style="text-align:right;">√ñsszesen</th>`;
            breakdown.forEach(item => {
                if (detailLevel === 'simple') {
                    tableRows += `<tr><td>${item.label}</td><td style="text-align:right;">${formatCustomCurrency(convertPrice(item.totalHuf, currency), symbol)}</td></tr>`;
                } else {
                    let cells = `<td>${item.label}</td><td style="text-align:right;">${item.quantity.toLocaleString('hu-HU')} ${item.unit}</td><td style="text-align:right;">${formatCustomCurrency(convertPrice(item.unitPriceHuf, currency), symbol)}</td>`;
                    if(showCost) {
                        cells += `<td style="text-align:right;">${item.isCostItem ? formatCustomCurrency(convertPrice(item.totalCostHuf, currency), symbol) : '-'}</td>`;
                    }
                    cells += `<td style="text-align:right;">${formatCustomCurrency(convertPrice(item.totalHuf, currency), symbol)}</td>`;
                    tableRows += `<tr>${cells}</tr>`;
                }
            });
            
            let footerHtml = '';
            if (showCost) {
                const totalCostFinal = convertPrice(totalCostHuf, currency);
                footerHtml += `<tr><td colspan="${colspanForLabel}" style="text-align:right; font-weight:bold;">√ñnk√∂lts√©g √∂sszesen:</td><td style="text-align:right; font-weight:bold;">${formatCustomCurrency(totalCostFinal, symbol)}</td></tr>`;
            }

            const printHeader = `<div style="display:flex; justify-content:space-between; width:100%; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
                <div style="flex:1;">
                    <p><strong>Aj√°nlatsz√°m:</strong> ${inputs.offer_number||'-'}</p><p><strong>Projektsz√°m:</strong> ${inputs.project_number||'-'}</p><p><strong>D√°tum:</strong> ${new Date(inputs.calculation_date).toLocaleDateString('hu-HU')}</p>
                </div><div style="flex:1; text-align:right;">
                    <p><strong>Megrendel≈ë:</strong> ${inputs.customer||'-'}</p><p><strong>Projekt neve:</strong> ${inputs.project_name||'-'}</p><p><strong>K√©sz√≠t≈ë:</strong> ${inputs.creator_name||'-'}</p>
                </div></div>`;
            
            let summaryHtml = `<div style="padding: 10px; margin-bottom: 20px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 4px;">`;
            summaryHtml += `<p><strong>Feladat:</strong> ${inputs.feladat || 'Nincs megadva'}</p>`;
            if (inputs.szerelo_fo > 0) { 
                const hoursText = detailLevel === 'internal' ? `, napi ${inputs.szerelo_munkaora} √≥r√°ban` : '';
                summaryHtml += `<p>${inputs.szerelo_fo} szerel≈ë, ${inputs.szerelo_munkanap} munkanap (ebb≈ël ${inputs.szerelo_hetvegi_nap} h√©tv√©ge)${hoursText}.</p>`; 
            }
            if (inputs.mernok_fo > 0) { 
                const hoursText = detailLevel === 'internal' ? `, napi ${inputs.mernok_munkaora} √≥r√°ban` : '';
                summaryHtml += `<p>${inputs.mernok_fo} m√©rn√∂k, ${inputs.mernok_munkanap} munkanap (ebb≈ël ${inputs.mernok_hetvegi_nap} h√©tv√©ge)${hoursText}.</p>`; 
            }
            summaryHtml += `</div>`;
            const watermarkText = detailLevel === 'internal' ? "TELJES (BELS≈ê)" : "";
            return `<!DOCTYPE html><html lang="hu"><head><meta charset="UTF-8"><title>Kalkul√°ci√≥</title><style>@font-face{font-family:'DejaVuSans';src:url('https://cdn.jsdelivr.net/gh/dejavu-fonts/dejavu-fonts-ttf/ttf/DejaVuSans.ttf') format('truetype');} @page{size:A4;margin:25mm;} body{font-family:'DejaVuSans',sans-serif;font-size:10px;color:#333; background-color: #ffffff !important;} h1{text-align:center;} p{margin: 2px 0;} .watermark{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-45deg);font-size:100px;color:rgba(128,0,0,0.08);z-index:-1;font-weight:bold;pointer-events:none;} table{width:100%;border-collapse:collapse;margin-top:20px;} th,td{border:1px solid #ccc;padding:6px;text-align:left;} th{background-color:#f2f2f2;} .summary-table{margin-top:20px;width:60%;margin-left:auto;border:none;} .summary-table td{border:none;}</style></head><body>${detailLevel === 'internal' ? `<div class="watermark">${watermarkText}</div>` : ''}<h1>Kisz√°ll√°s kalkul√°ci√≥</h1>${printHeader}${summaryHtml}<table><thead><tr><th>Le√≠r√°s</th>${headerCols}</tr></thead><tbody>${tableRows}</tbody></table><table class="summary-table"><tbody>${footerHtml}<tr><td colspan="${colspanForLabel}" style="text-align:right;">Nett√≥ v√©g√∂sszeg:</td><td style="text-align:right;">${formatCustomCurrency(totalSellFinal,symbol)}</td></tr>${discount>0?`<tr><td colspan="${colspanForLabel}" style="text-align:right;">Kedvezm√©ny (${discount}%):</td><td style="text-align:right;">- ${formatCustomCurrency(totalSellFinal-discountedTotal,symbol)}</td></tr><tr><td colspan="${colspanForLabel}" style="text-align:right;"><strong>Kedvezm√©nyes nett√≥ v√©g√∂sszeg:</strong></td><td style="text-align:right;"><strong>${formatCustomCurrency(discountedTotal,symbol)}</strong></td></tr>`:''}</tbody></table></body></html>`;
        }

        function getRateListPrintableHtml(pkg) {
            const allRates = { ...pkg.rates.fixed, ...pkg.rates.overridable };
            let tableRows = '';
            Object.entries(allRates).forEach(([key, value]) => {
                if (!key.endsWith('_szorzo')) {
                     tableRows += `<tr><td>${state.config.RATE_KEY_LABELS[key] || key}</td><td style="text-align:right;">${formatCustomCurrency(value, 'Ft')}</td></tr>`;
                }
            });
            const title = `√Årlista: ${pkg.name}`;
            return `<!DOCTYPE html><html lang="hu"><head><meta charset="UTF-8"><title>${title}</title><style>@font-face{font-family:'DejaVuSans';src:url('https://cdn.jsdelivr.net/gh/dejavu-fonts/dejavu-fonts-ttf/ttf/DejaVuSans.ttf') format('truetype');} @page{size:A4;margin:25mm 50mm;} body{font-family:'DejaVuSans',sans-serif;font-size:10px;color:#333; background-color: #ffffff !important;} table{width:100%;border-collapse:collapse;margin-top:20px;} th,td{border:1px solid #ccc;padding:8px;text-align:left;} th{background-color:#f2f2f2;}</style></head><body><h1>${title}</h1><p><strong>D√°tum:</strong> ${new Date().toLocaleDateString('hu-HU')}</p><table><thead><tr><th>Megnevez√©s</th><th style="text-align:right;">Egys√©g√°r (Ft)</th></tr></thead><tbody>${tableRows}</tbody></table></body></html>`;
        }

        function setupOtherCostsList() {
            const container = D('other-costs-list');
            container.innerHTML = state.otherCosts.map((item, index) => {
                const amountLabel = item.isCostItem ? '√ñnk√∂lts√©g (HUF)' : '√År (HUF)';
                const multiplierVisibilityClass = item.isCostItem ? '' : 'hidden';

                return `
                <div class="other-cost-item">
                    <div class="other-cost-row-1">
                        <div class="form-group description">
                            <label>Le√≠r√°s</label>
                            <input type="text" data-index="${index}" data-field="description" value="${item.description}">
                        </div>
                        <button class="btn btn-danger other-cost-delete-btn delete-btn" data-index="${index}">√ó</button>
                    </div>
                    <div class="other-cost-row-2">
                        <div class="form-group quantity"><label>Menny.</label><input type="number" data-index="${index}" data-field="quantity" value="${item.quantity}"></div>
                        <div class="form-group unit"><label>Egys√©g</label><input type="text" data-index="${index}" data-field="unit" value="${item.unit}"></div>
                        <div class="form-group amount"><label>${amountLabel}</label><input type="number" data-index="${index}" data-field="amount" value="${item.amount}"></div>
                        <div class="form-group is-cost-item-group"><input type="checkbox" id="is-cost-item-${index}" data-index="${index}" data-field="isCostItem" ${item.isCostItem ? 'checked' : ''}><label for="is-cost-item-${index}">√ñnk√∂lts√©ges?</label></div>
                        <div class="form-group multiplier ${multiplierVisibilityClass}"><label>Haszonkulcs (%)</label><input type="number" data-index="${index}" data-field="multiplier" value="${item.multiplier}"></div>
                    </div>
                </div>`;
            }).join('');
        }

        function handleOtherCostInput(e) {
            const target = e.target;
            const index = parseInt(target.dataset.index, 10);
            const field = target.dataset.field;
            if (!isNaN(index) && field && state.otherCosts[index]) {
                const value = target.type === 'checkbox' ? target.checked : (target.type === 'number' ? parseFloat(target.value) || 0 : target.value);
                state.otherCosts[index][field] = value;
                if (field === 'isCostItem') {
                    setupOtherCostsList(); // Re-render to update labels and visibility
                }
                calculateAndDisplay();
            }
        }
        
        function handleTravelUnitToggle() {
            const input = D('utazas_ido_ora');
            const label = document.querySelector('label[for="utazas_ido_ora"]');
            let currentValue = parseFloat(input.value) || 0;

            if (state.travelTimeUnit === '√≥ra') {
                state.travelTimeUnit = 'perc';
                input.value = (currentValue * 60).toFixed(0);
                label.innerHTML = `Utaz√°si id≈ë (<span class="travel-unit-toggle">perc</span>, oda)`;
            } else {
                state.travelTimeUnit = '√≥ra';
                input.value = (currentValue / 60).toFixed(2);
                label.innerHTML = `Utaz√°si id≈ë (<span class="travel-unit-toggle">√≥ra</span>, oda)`;
            }
            calculateAndDisplay();
        }

        D('password-form').onsubmit = (e) => {
            e.preventDefault(); 
            if (D('password-input').value === ADMIN_PASSWORD) {
                D('landing-page').style.display = 'none'; 
                D('app-container').style.display = 'block'; 
                initApp();
            } else { alert("Hib√°s jelsz√≥!"); }
        };
    </script>
</body>
</html>