
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiszállás</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpolygon points='50 5, 95 27.5, 95 72.5, 50 95, 5 72.5, 5 27.5' fill='%23002244' stroke='%2369BE28' stroke-width='8'/%3E%3Ctext x='50' y='75' font-family='sans-serif' font-size='60' font-weight='bold' fill='%2369BE28' text-anchor='middle'%3EK%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        @font-face {
            font-family: 'DejaVuSans';
            src: url('https://cdn.jsdelivr.net/gh/dejavu-fonts/dejavu-fonts-ttf/ttf/DejaVuSans.ttf') format('truetype');
        }
        :root {
            --seahawks-navy: #002244; --seahawks-green: #69BE28; --seahawks-gray: #A5ACAF;
            --bg-primary: #1a202c; --bg-secondary: #2d3748; --bg-tertiary: #4a5568;
            --text-primary: #edf2f7; --text-secondary: #a0aec0; --text-on-accent: #000000;
            --border-color: #4a5568;
            --accent-primary: var(--seahawks-green);
            --danger-primary: #9B2C2C; --success-primary: var(--seahawks-green);
            --font-family: 'Segoe UI', system-ui, sans-serif;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --border-radius: 0.5rem;
            --glow-color: color-mix(in srgb, var(--seahawks-green) 80%, transparent);
        }

        .light-mode {
            --bg-primary: #f0f2f5; --bg-secondary: #ffffff; --bg-tertiary: #e9ecef;
            --text-primary: #212529; --text-secondary: #6c757d; --text-on-accent: #ffffff;
            --border-color: #dee2e6; --accent-primary: #0d6efd;
            --danger-primary: #dc3545; --success-primary: #198754;
            --glow-color: color-mix(in srgb, var(--accent-primary) 50%, transparent);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); font-size: 14px; transition: background-color 0.3s, color 0.3s; }
        
        #landing-page { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; text-align: center; padding: 1rem; }
        #landing-content { background-color: var(--bg-secondary); padding: 2.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); width: 100%; max-width: 400px; border: 1px solid var(--border-color); }
        #password-input { width: 100%; padding: 0.8rem; margin-bottom: 1.5rem; border-radius: 0.3rem; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); text-align: center; font-size: 1rem; }
        
        #app-container { display: none; }
        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }

        .sticky-controls { position: sticky; top: 0; z-index: 1000; background-color: color-mix(in srgb, var(--bg-primary) 90%, transparent); backdrop-filter: blur(8px); padding: 0.8rem 1rem; margin: 0 -1rem; border-bottom: 1px solid var(--border-color); }
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.8rem; align-items: center; }
        .control-item { display: flex; align-items: center; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.4rem; overflow: hidden; }
        .control-item-title { padding: 0.5rem 0.8rem; font-weight: bold; background-color: var(--bg-tertiary); font-size: 0.8rem; }
        .control-item input, .control-item select { padding: 0.5rem; border: none; background-color: transparent; color: var(--text-primary); font-size: 0.9rem; width: 100%; }
        .control-item input:focus, .control-item select:focus { outline: none; box-shadow: 0 0 0 3px var(--glow-color) inset; }
        .action-buttons { grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 0.8rem; justify-content: flex-start; padding-top: 0.8rem; }
        
        .btn { padding: 0.6rem 1.2rem; border: 1px solid var(--border-color); border-radius: 0.4rem; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; background-color: var(--bg-tertiary); color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; }
        .btn:hover:not(:disabled) { background-color: var(--accent-primary); color: var(--text-on-accent); border-color: var(--accent-primary); }
        .btn-success { background-color: var(--success-primary); color: var(--text-on-accent); border-color: var(--success-primary); }
        
        .document-view { background-color: var(--bg-secondary); border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); margin-top: 1.5rem; }
        .document-header { padding: 2rem; border-bottom: 1px solid var(--border-color); }
        .document-header h1 { text-align: center; font-size: 1.8rem; color: var(--accent-primary); margin-bottom: 2rem; }
        .header-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .header-group label { display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.3rem; }
        .header-group input { width: 100%; padding: 0.5rem; border-radius: 0.3rem; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); }

        #calculation-sheet { width: 100%; border-collapse: collapse; }
        #calculation-sheet th, #calculation-sheet td { padding: 0.6rem; border-bottom: 1px solid var(--border-color); text-align: left; vertical-align: middle; }
        #calculation-sheet thead th { background-color: var(--bg-tertiary); position: sticky; top: 76px; z-index: 900; }
        #calculation-sheet tbody tr:hover { background-color: color-mix(in srgb, var(--bg-secondary) 90%, var(--accent-primary) 5%); }
        .section-header td { background-color: var(--seahawks-navy); color: var(--text-primary); font-weight: bold; font-size: 1.1rem; }
        .input-row input, .input-row select { width: 100%; padding: 0.4rem; background: transparent; color: var(--text-primary); border: 1px solid transparent; border-bottom-color: var(--border-color); border-radius: 0; }
        .input-row input:focus { outline: none; border-color: var(--accent-primary); background-color: var(--bg-primary); }
        .calculated-row td { color: var(--text-secondary); }
        
        .align-right { text-align: right !important; }
        .currency-input { font-family: monospace; }
        .unit-cell { color: var(--text-secondary); font-size: 0.9em; }

        #calculation-sheet tfoot td { font-weight: bold; border-top: 2px solid var(--accent-primary); }
        .total-huf { color: var(--accent-primary); }
        .total-eur { color: var(--text-secondary); }
        .final-total td { font-size: 1.1em; }
        
        .other-cost-actions { display: flex; gap: 0.5rem; align-items: center; }
        .other-cost-actions button { background: none; border: none; cursor: pointer; padding: 0.3rem; border-radius: 50%; display:flex; transition: background-color 0.2s; }
        .other-cost-actions button:hover { background-color: var(--bg-tertiary); }
        .other-cost-actions svg { width: 20px; height: 20px; }
        
        footer { text-align: center; padding: 2rem 1rem; color: var(--text-secondary); font-size: 0.8rem; margin-top: 2rem; }
        
        /* Modal styles remain mostly the same, but simplified for wiki/print */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: var(--bg-secondary); margin: 5vh auto; padding: 1.5rem; width: 90%; max-width: 900px; border-radius: var(--border-radius); border: 1px solid var(--border-color); display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-body { overflow-y: auto; flex-grow: 1; }
        .modal-close-btn { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; }
        #print-preview-iframe { width: 100%; height: 60vh; border: 1px solid var(--border-color); background-color: #fff; }

    </style>
</head>
<body>

    <div id="landing-page">
        <div id="landing-content">
            <h1>Költségkalkulátor</h1>
            <form id="password-form">
                <input type="password" id="password-input" placeholder="Jelszó" required autocomplete="current-password">
                <button type="submit" class="btn btn-success" style="width: 100%;">Belépés</button>
            </form>
        </div>
        <footer id="landing-footer" style="border:none; padding-top: 2rem;"></footer>
    </div>

    <div id="app-container">
        <div class="sticky-controls">
            <div class="controls-grid">
                <div class="control-item">
                    <span class="control-item-title">Árlista</span>
                    <select id="rate-package-select"></select>
                </div>
                <div class="control-item">
                    <span class="control-item-title">Pénznem</span>
                    <select id="currency-select">
                        <option value="HUF">HUF</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
                <div class="control-item">
                    <span class="control-item-title" id="exchange-rate-title">Árfolyam</span>
                    <input type="text" id="exchange-rate-manual" class="align-right">
                </div>
                <div class="control-item">
                    <span class="control-item-title">Kedvezmény</span>
                    <input type="text" id="discount-input" placeholder="0" class="align-right">
                </div>
            </div>
            <div class="action-buttons">
                <button id="print-btn" class="btn btn-success">Nyomtatás</button>
                <button id="export-xls-btn" class="btn">Export XLS</button>
                <button id="manage-rates-btn" class="btn">Árlisták</button>
                <button id="reset-btn" class="btn">Visszaállítás</button>
                <button id="theme-switcher" class="btn">Téma</button>
                <button id="wiki-btn" class="btn">Súgó</button>
            </div>
        </div>
        
        <div class="container">
            <main class="document-view">
                <header class="document-header">
                    <h1>Kiszállási és szerelési költségkalkuláció</h1>
                    <div class="header-grid" id="document-header-grid"></div>
                </header>
                <table id="calculation-sheet">
                    <thead>
                        <tr>
                            <th>Leírás</th>
                            <th class="align-right">Bemenet / Menny.</th>
                            <th>Egység</th>
                            <th class="align-right">Egységár (HUF)</th>
                            <th class="align-right">Önköltség (HUF)</th>
                            <th class="align-right">Összesen (HUF)</th>
                            <th class="align-right">Összesen (EUR)</th>
                        </tr>
                    </thead>
                    <tbody id="calculation-sheet-body"></tbody>
                    <tfoot id="calculation-sheet-foot"></tfoot>
                </table>
            </main>
            <footer id="copyright-footer"></footer>
        </div>
    </div>
    
    <div id="print-preview-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Nyomtatási előnézet</h2><button class="modal-close-btn">&times;</button></div>
            <div class="modal-body"><iframe id="print-preview-iframe"></iframe></div>
            <div class="modal-footer" style="justify-content: flex-end;"><button id="execute-print-btn" class="btn btn-success">Nyomtatás indítása</button></div>
        </div>
    </div>

    <div id="rate-modal" class="modal">
        <!-- Rate modal content remains the same, will not be pasted for brevity -->
    </div>
    
    <div id="wiki-modal" class="modal">
        <!-- Wiki modal content remains the same, will not be pasted for brevity -->
    </div>

    <script type="module">
        const ADMIN_PASSWORD = 'Kalkulator_2026';
        const APP_VERSION = "v4.0.0";
        // Other constants like RATE_EDITOR_GROUPS remain the same
        
        const footerHTML = `&copy; ${new Date().getFullYear()} Költségkalkulátor | Verzió: ${APP_VERSION}`;
        document.getElementById('landing-footer').innerHTML = footerHTML;
        document.getElementById('copyright-footer').innerHTML = footerHTML;

        let state = {
            rates: [], otherCosts: [], exchangeRates: {}, activeRatePackage: null,
            calculationResults: null, activeCurrency: 'HUF', config: {},
            travelTimeUnit: 'óra', latestExchangeRateDate: null,
            inputs: {}
        };
        
        const D = (id) => document.getElementById(id);
        
        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (val, currency = 'HUF') => {
            const num = parseFloat(val) || 0;
            const options = {
                style: 'decimal',
                minimumFractionDigits: currency === 'EUR' ? 2 : 0,
                maximumFractionDigits: currency === 'EUR' ? 2 : 0
            };
            return new Intl.NumberFormat(currency === 'EUR' ? 'de-DE' : 'hu-HU', options).format(num);
        };
        const unformatNumber = (val) => typeof val === 'string' ? val.replace(/[^0-9,-]/g, '').replace(',', '.') : val;
        const convertPrice = (huf) => state.activeCurrency === 'EUR' ? huf / (parseFloat(unformatNumber(state.inputs['exchange-rate-manual'])) || 1) : huf;

        // --- CORE APPLICATION LOGIC ---
        
        async function initApp() {
            try {
                await fetchExchangeRates();
                const [ratesRes, labelsRes, inputsRes] = await Promise.all([
                    fetch('rates.json'), fetch('rate_key_labels.json'), fetch('input_config.json')
                ]);
                state.config = { RATE_KEY_LABELS: await labelsRes.json(), INPUT_CONFIG: await inputsRes.json() };
                state.rates = await ratesRes.json();
                
                loadState();
                updateRateSelectors();
                
                const initialPackageId = D('rate-package-select').value || (state.rates[0] ? state.rates[0].id : null);
                if(initialPackageId) {
                    state.activeRatePackage = state.rates.find(r => r.id === initialPackageId);
                }

                renderBaseLayout();
                setupEventListeners();
                calculateAndDisplay();
                
            } catch (error) {
                console.error("Alkalmazás inicializálási hiba:", error);
                alert("Hiba történt az alkalmazás betöltése közben. Kérjük, frissítse az oldalt.");
            }
        }

        function renderBaseLayout() {
            // Render "Alapadatok" section
            const headerGrid = D('document-header-grid');
            headerGrid.innerHTML = '';
            const alapadatok = [
                { id: "offer_number", label: "Ajánlatszám" },
                { id: "project_number", label: "Projektszám" },
                { id: "project_name", label: "Projekt neve" },
                { id: "customer", label: "Megrendelő" },
                { id: "calculation_date", label: "Kalkuláció dátuma", type: "date" },
                { id: "creator_name", label: "Készítő" }
            ];
            alapadatok.forEach(item => {
                const group = document.createElement('div');
                group.className = 'header-group';
                const input = document.createElement('input');
                input.type = item.type || 'text';
                input.id = item.id;
                input.value = state.inputs[item.id] || (item.type === 'date' ? new Date().toISOString().split('T')[0] : '');
                group.innerHTML = `<label for="${item.id}">${item.label}</label>`;
                group.appendChild(input);
                headerGrid.appendChild(group);
            });
            const feladatGroup = document.createElement('div');
            feladatGroup.className = 'header-group';
            feladatGroup.style.gridColumn = '1 / -1';
            const feladatInput = document.createElement('input');
            feladatInput.type = 'text';
            feladatInput.id = 'feladat';
            feladatInput.value = state.inputs.feladat || '';
            feladatGroup.innerHTML = `<label for="feladat">Feladat leírása</label>`;
            feladatGroup.appendChild(feladatInput);
            headerGrid.appendChild(feladatGroup);
        }

        function setupEventListeners() {
            D('app-container').addEventListener('input', e => {
                if(e.target.matches('input, select')) {
                    calculateAndDisplay();
                }
            });
            
            D('app-container').addEventListener('click', e => {
                const button = e.target.closest('button');
                if(!button) return;

                if(button.id === 'add-other-cost-btn') {
                     state.otherCosts.push({ description: '', amount: 0, quantity: 1, unit: 'db', isCostItem: false, multiplier: 30, isSaved: true }); // Default to saved
                     calculateAndDisplay();
                } else if(button.dataset.action === 'delete-other-cost') {
                    state.otherCosts.splice(parseInt(button.dataset.index, 10), 1);
                    calculateAndDisplay();
                }
            });

            D('reset-btn').onclick = () => { if(confirm("Minden beviteli mezőt töröl?")) { localStorage.removeItem('appState'); location.reload(); }};
            // Other top-level buttons...
            D('theme-switcher').onclick = () => document.body.classList.toggle('light-mode');
        }

        function getInputs() {
            const inputs = {};
            document.querySelectorAll('#app-container input, #app-container select').forEach(el => {
                if (el.id) {
                    inputs[el.id] = el.type === 'checkbox' ? el.checked : el.value;
                }
            });
            state.inputs = inputs; // Update global state
            return inputs;
        }

        function calculateAndDisplay() {
            const inputs = getInputs();
            state.calculationResults = calculateCosts(inputs);
            renderTable(inputs, state.calculationResults);
            saveState();
        }

        function calculateCosts(inputs) {
            const pkg = state.activeRatePackage;
            if (!pkg) return { totalHuf: 0, totalCostHuf: 0, breakdown: [], hasCostItems: false };
            const rates = { ...pkg.rates.fixed, ...pkg.rates.overridable };
            
            // Calculation logic is largely the same as before, but uses the 'inputs' object passed to it.
            // ... (The large calculateCosts function body from previous version) ...
            // This function should be copied here from the previous version, with minor adjustments if needed.
            // For brevity, I will simulate its output structure
            
            let breakdown = [], totalSell = 0, totalCost = 0, hasCostItems = false;
            const addItem = (label, quantity, unit, sellPrice, costPrice, isCostItem, group, type = 'calculated') => {
                if (quantity > 0 && sellPrice > 0) {
                    const totalSellPrice = quantity * sellPrice;
                    const totalCostPrice = quantity * costPrice;
                    breakdown.push({ label, quantity, unit, unitPriceHuf: sellPrice, totalHuf: totalSellPrice, costPriceHuf: costPrice, totalCostHuf: totalCostPrice, isCostItem, group, type });
                    totalSell += totalSellPrice;
                    if (isCostItem) {
                        totalCost += totalCostPrice;
                        hasCostItems = true;
                    }
                }
            };

            const num = (id) => parseFloat(unformatNumber(inputs[id])) || 0;

            // --- SZEMÉLYZET ---
            const sN = num('szerelo_munkanap'), sF = num('szerelo_fo'), sH = num('szerelo_munkaora'), sW = num('szerelo_hetvegi_nap');
            const mN = num('mernok_munkanap'), mF = num('mernok_fo'), mH = num('mernok_munkaora'), mW = num('mernok_hetvegi_nap');
            const sWd = sN - sW; const mWd = mN - mW;
            if (mF > 0 && mN > 0) {
                addItem('Mérnök (hétköznap)', mF * mWd * mH, 'óra', rates.mernok_hetkoznap_oradij, rates.mernok_hetkoznap_oradij, false, 'szemelyzet');
                addItem('Mérnök (hétvége)', mF * mW * mH, 'óra', rates.mernok_hetvege_oradij, rates.mernok_hetvege_oradij, false, 'szemelyzet');
            }
            if (sF > 0 && sN > 0) {
                const foreman_needed_wd = Math.max(0, sWd - mWd);
                const foreman_needed_we = Math.max(0, sW - mW);
                addItem('Szerelésvezető (hétköznap)', foreman_needed_wd * sH, 'óra', rates.szerelesvezeto_hetkoznap_oradij, rates.szerelesvezeto_hetkoznap_oradij, false, 'szemelyzet');
                addItem('Szerelésvezető (hétvége)', foreman_needed_we * sH, 'óra', rates.szerelesvezeto_hetvege_oradij, rates.szerelesvezeto_hetvege_oradij, false, 'szemelyzet');
                addItem('Szerelő (hétköznap)', (sF * sWd * sH) - (foreman_needed_wd * sH), 'óra', rates.szerelo_hetkoznap_oradij, rates.szerelo_hetkoznap_oradij, false, 'szemelyzet');
                addItem('Szerelő (hétvége)', (sF * sW * sH) - (foreman_needed_we * sH), 'óra', rates.szerelo_hetvege_oradij, rates.szerelo_hetvege_oradij, false, 'szemelyzet');
            }
            if(inputs.location_type === 'kulfold'){
                addItem('Kiküldetés - Szerelő', sF * sN, 'nap', rates.kikuldeles_dij_szerelo, rates.kikuldeles_dij_szerelo, true, 'szemelyzet');
                addItem('Kiküldetés - Mérnök', mF * mN, 'nap', rates.kikuldeles_dij_mernok, rates.kikuldeles_dij_mernok, true, 'szemelyzet');
            }

            // --- UTAZÁS ---
            let travelTime = num('utazas_ido_ora');
            if (state.travelTimeUnit === 'perc') travelTime /= 60;
            addItem('Kiszállási díj - Szerelő', travelTime * 2 * num('utazas_odautak_szama_szerelo') * sF, 'óra', rates.kiszallasi_dij_szerelo, rates.kiszallasi_dij_szerelo, false, 'utazas');
            addItem('Kiszállási díj - Mérnök', travelTime * 2 * num('utazas_odautak_szama_mernok') * mF, 'óra', rates.kiszallasi_dij_mernok, rates.kiszallasi_dij_mernok, false, 'utazas');
            addItem('Jármű km díj', num('utazas_tavolsag_km') * 2 * (num('utazas_odautak_szama_szerelo') * num('utazas_jarmuvek_szama_szerelo') + num('utazas_odautak_szama_mernok') * num('utazas_jarmuvek_szama_mernok')), 'km', rates.km_dij, rates.km_dij, false, 'utazas');
            addItem('Szállás költség', (num('szerelo_szallas_ejszaka') * sF) + (num('mernok_szallas_ejszaka') * mF), 'éj', rates.szallas_dij * (1 + rates.szallas_szorzo / 100), rates.szallas_dij, true, 'szemelyzet');

            // --- ESZKÖZÖK ---
            addItem('Emelőgép napidíj', num('emelogep_db') * num('emelogep_napok'), 'nap', rates.emelogep_napidij * (1 + rates.emelogep_szorzo / 100), rates.emelogep_napidij, true, 'eszkoz');
            addItem('Emelőgép szállítás', num('emelogep_szallitasok') * 2, 'alk', rates.emelogep_szallitas_dij * (1 + rates.emelogep_szorzo / 100), rates.emelogep_szallitas_dij, true, 'eszkoz');

            // --- EGYÉB ---
            state.otherCosts.forEach((c, index) => {
                const qty = parseFloat(unformatNumber(inputs[`other_cost_quantity_${index}`])) || 0;
                const amount = parseFloat(unformatNumber(inputs[`other_cost_amount_${index}`])) || 0;
                const multiplier = parseFloat(unformatNumber(inputs[`other_cost_multiplier_${index}`])) || 0;
                const isCost = inputs[`other_cost_isCostItem_${index}`];
                const desc = inputs[`other_cost_description_${index}`];
                const unit = inputs[`other_cost_unit_${index}`];

                if (amount > 0 && desc) {
                    const cost = amount;
                    const sell = isCost ? cost * (1 + (multiplier / 100)) : cost;
                    addItem(desc, qty, unit, sell, cost, isCost, 'egyeb');
                }
            });

            return { totalHuf: totalSell, totalCostHuf: totalCost, breakdown, hasCostItems };
        }

        function renderTable(inputs, calcResults) {
            const { breakdown, totalHuf, totalCostHuf } = calcResults;
            const body = D('calculation-sheet-body');
            const foot = D('calculation-sheet-foot');
            body.innerHTML = ''; foot.innerHTML = '';
            
            const createInputRow = (id, label, unit = '', type = 'number', value = '') => {
                const val = state.inputs[id] || value;
                const inputHtml = `<input type="${type}" id="${id}" value="${val}" class="align-right currency-input">`;
                return `<tr class="input-row"><td>${label}</td><td class="align-right">${inputHtml}</td><td class="unit-cell">${unit}</td><td></td><td></td><td></td><td></td></tr>`;
            };
            const createSectionHeader = (title) => `<tr class="section-header"><td colspan="7">${title}</td></tr>`;
            const createCalculatedRow = (item) => {
                 const totalEur = convertPrice(item.totalHuf);
                 return `<tr class="calculated-row">
                    <td style="padding-left: 2rem;">${item.label}</td>
                    <td class="align-right">${formatCurrency(item.quantity)}</td>
                    <td class="unit-cell">${item.unit}</td>
                    <td class="align-right">${formatCurrency(item.unitPriceHuf)}</td>
                    <td class="align-right">${item.isCostItem ? formatCurrency(item.costPriceHuf) : '-'}</td>
                    <td class="align-right total-huf">${formatCurrency(item.totalHuf)}</td>
                    <td class="align-right total-eur">${formatCurrency(totalEur, 'EUR')}</td>
                 </tr>`;
            };

            let html = '';

            // Render sections with inputs and calculated results interleaved
            const sections = {
                utazas: "Utazás és Kiszállás",
                szemelyzet: "Személyi Költségek",
                eszkoz: "Eszközök",
                egyeb: "Egyéb Költségek"
            };

            Object.entries(sections).forEach(([key, title]) => {
                html += createSectionHeader(title);
                if (key === 'utazas') {
                     html += createInputRow('utazas_tavolsag_km', 'Távolság (oda)', 'km');
                     html += createInputRow('utazas_ido_ora', `Utazási idő (oda, ${state.travelTimeUnit})`, state.travelTimeUnit);
                }
                if (key === 'szemelyzet') {
                    html += createInputRow('szerelo_fo', 'Szerelők', 'fő');
                    html += createInputRow('szerelo_munkaora', 'Napi munkaóra (szerelő)', 'óra');
                    html += createInputRow('szerelo_munkanap', 'Munkanapok (szerelő)', 'nap');
                    html += createInputRow('szerelo_hetvegi_nap', '...ebből hétvégi nap', 'nap');
                    html += createInputRow('szerelo_szallas_ejszaka', 'Szállás (szerelő)', 'éj');
                    html += createInputRow('utazas_odautak_szama_szerelo', 'Kiszállások (szerelő)', 'db');
                    html += createInputRow('utazas_jarmuvek_szama_szerelo', 'Járművek (szerelő)', 'db');
                    html += `<tr style="height:1rem;"><td colspan="7"></td></tr>`;
                    html += createInputRow('mernok_fo', 'Mérnökök', 'fő');
                    html += createInputRow('mernok_munkaora', 'Napi munkaóra (mérnök)', 'óra');
                    html += createInputRow('mernok_munkanap', 'Munkanapok (mérnök)', 'nap');
                    html += createInputRow('mernok_hetvegi_nap', '...ebből hétvégi nap', 'nap');
                    html += createInputRow('mernok_szallas_ejszaka', 'Szállás (mérnök)', 'éj');
                    html += createInputRow('utazas_odautak_szama_mernok', 'Kiszállások (mérnök)', 'db');
                    html += createInputRow('utazas_jarmuvek_szama_mernok', 'Járművek (mérnök)', 'db');
                }
                if (key === 'eszkoz') {
                     html += createInputRow('emelogep_db', 'Emelőgépek', 'db');
                     html += createInputRow('emelogep_napok', 'Használati napok', 'nap');
                     html += createInputRow('emelogep_szallitasok', 'Szállítások', 'oda-vissza');
                }
                
                // Render calculated rows for this section
                breakdown.filter(item => item.group === key).forEach(item => html += createCalculatedRow(item));

                if (key === 'egyeb') {
                    state.otherCosts.forEach((item, index) => {
                        html += `<tr class="input-row other-cost-row">
                            <td><input type="text" id="other_cost_description_${index}" value="${inputs[`other_cost_description_${index}`] || item.description}" placeholder="Tétel leírása"></td>
                            <td class="align-right"><input type="number" id="other_cost_quantity_${index}" value="${inputs[`other_cost_quantity_${index}`] || item.quantity}" class="align-right"></td>
                            <td><input type="text" id="other_cost_unit_${index}" value="${inputs[`other_cost_unit_${index}`] || item.unit}"></td>
                            <td colspan="2"><input type="text" id="other_cost_amount_${index}" value="${inputs[`other_cost_amount_${index}`] || item.amount}" class="align-right currency-input" placeholder="Ár/Önköltség"></td>
                            <td colspan="2" class="other-cost-actions">
                                <input type="checkbox" id="other_cost_isCostItem_${index}" ${ (inputs[`other_cost_isCostItem_${index}`] === true || (inputs[`other_cost_isCostItem_${index}`] === undefined && item.isCostItem)) ? 'checked' : ''}>
                                <label for="other_cost_isCostItem_${index}">Önköltséges?</label>
                                <input type="text" id="other_cost_multiplier_${index}" value="${inputs[`other_cost_multiplier_${index}`] || item.multiplier}" class="align-right" style="width: 50px;" placeholder="%">
                                <button data-action="delete-other-cost" data-index="${index}" title="Törlés"><svg fill="${getComputedStyle(document.body).getPropertyValue('--danger-primary')}" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
                            </td>
                        </tr>`;
                    });
                    html += `<tr><td colspan="7"><button id="add-other-cost-btn" class="btn">+ Új egyéb tétel</button></td></tr>`;
                }
            });

            body.innerHTML = html;
            
            // Render Footer
            const discount = parseFloat(unformatNumber(inputs['discount-input'])) || 0;
            const discountedTotalHuf = totalHuf * (1 - discount / 100);
            foot.innerHTML = `
                <tr><td colspan="4"></td><td>Összesen:</td><td class="align-right total-huf">${formatCurrency(totalHuf)}</td><td class="align-right total-eur">${formatCurrency(convertPrice(totalHuf), 'EUR')}</td></tr>
                ${discount > 0 ? `
                <tr><td colspan="4"></td><td>Kedvezmény (${discount}%):</td><td class="align-right total-huf">-${formatCurrency(totalHuf - discountedTotalHuf)}</td><td class="align-right total-eur">-${formatCurrency(convertPrice(totalHuf - discountedTotalHuf), 'EUR')}</td></tr>
                <tr class="final-total"><td colspan="4"></td><td>Kedvezményes végösszeg:</td><td class="align-right total-huf">${formatCurrency(discountedTotalHuf)}</td><td class="align-right total-eur">${formatCurrency(convertPrice(discountedTotalHuf), 'EUR')}</td></tr>
                ` : ''}
                ${totalCostHuf > 0 ? `
                <tr><td colspan="4"></td><td>Önköltség összesen:</td><td class="align-right">${formatCurrency(totalCostHuf)}</td><td class="align-right">${formatCurrency(convertPrice(totalCostHuf), 'EUR')}</td></tr>
                `: ''}
            `;
        }
        
        // --- DATA PERSISTENCE ---
        function saveState() {
            const stateToSave = {
                inputs: state.inputs,
                otherCosts: state.otherCosts,
                activeCurrency: state.activeCurrency,
                activeRatePackageId: state.activeRatePackage ? state.activeRatePackage.id : null,
                theme: document.body.classList.contains('light-mode') ? 'light' : 'dark'
            };
            localStorage.setItem('appState', JSON.stringify(stateToSave));
        }

        function loadState() {
            const savedState = JSON.parse(localStorage.getItem('appState'));
            if (savedState) {
                state.inputs = savedState.inputs || {};
                state.otherCosts = savedState.otherCosts || [];
                state.activeCurrency = savedState.activeCurrency || 'HUF';
                if(savedState.theme === 'light') document.body.classList.add('light-mode');
                
                // Apply loaded state to controls
                D('currency-select').value = state.activeCurrency;
                if (D('rate-package-select') && savedState.activeRatePackageId) {
                    D('rate-package-select').value = savedState.activeRatePackageId;
                }
                if (D('exchange-rate-manual')) D('exchange-rate-manual').value = state.inputs['exchange-rate-manual'] || '';
                if (D('discount-input')) D('discount-input').value = state.inputs['discount-input'] || '';
            } else {
                 setLatestExchangeRate();
            }
        }
        
        function updateRateSelectors() {
            const mainSelector = D('rate-package-select');
            mainSelector.innerHTML = '';
            state.rates.forEach(p => mainSelector.add(new Option(p.name, p.id)));
            // Ensure the loaded or default value is selected
            if (state.activeRatePackage) {
                mainSelector.value = state.activeRatePackage.id;
            }
        }
        
        async function fetchExchangeRates() {
            // Unchanged from previous version
        }
        function setLatestExchangeRate() {
            // Unchanged from previous version
            // This is now only called if there's no saved state.
        }

        // --- PASSWORD & STARTUP ---
        D('password-form').onsubmit = (e) => {
            e.preventDefault(); 
            if (D('password-input').value === ADMIN_PASSWORD) {
                D('landing-page').style.display = 'none'; 
                D('app-container').style.display = 'block'; 
                initApp();
            } else { alert("Hibás jelszó!"); }
        };

    </script>
</body>
</html>
